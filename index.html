<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Sentiment Dashboard</title>
    <link rel="icon" href="favicon.ico">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --brand-blue: #0146bc;
            --brand-yellow: #eddc01;
            --brand-lightblue: #63c2de;
            --text-dark: #333333;
            --text-light: #ffffff;
            --bg-light: #f4f6f9;
            --border-color: #dcdcdc;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --font-legend: 'Avenir Next LT Pro', 'Avenir Next', 'Avenir', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --font-main: 'Roboto', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: var(--font-main); background-color: var(--bg-light); color: var(--text-dark); display: flex; flex-direction: column; min-height: 100vh; }

        header { background-color: var(--brand-blue); color: var(--text-light); padding: 1rem 2rem; border-bottom: 5px solid var(--brand-yellow); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { font-size: 1.5rem; font-weight: 500; }
        
        .header-actions { display: flex; gap: 10px; }
        .btn-header { background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; transition: background 0.2s; }
        .btn-header:hover { background-color: rgba(255,255,255,0.4); }

        .tabs-nav { display: flex; background: white; padding: 0 2rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .tab-button { padding: 1rem 2rem; border: none; background: none; font-size: 1rem; font-weight: 500; color: var(--text-dark); cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-button:hover { background-color: #f0f0f0; }
        .tab-button.active { color: var(--brand-blue); border-bottom: 3px solid var(--brand-blue); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        main { flex: 1; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }
        .section-title { font-size: 1.2rem; color: var(--brand-blue); margin-bottom: 1rem; border-left: 4px solid var(--brand-yellow); padding-left: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

        .upload-container { background: white; padding: 2rem; border-radius: 4px; border: 1px solid var(--border-color); text-align: center; margin-bottom: 2rem; transition: border-color 0.3s; position: relative; }
        .upload-container:hover { border-color: var(--brand-blue); }
        input[type="file"] { display: none; }
        .custom-file-upload { display: inline-block; padding: 12px 24px; cursor: pointer; background-color: var(--brand-blue); color: white; font-weight: 500; border-radius: 2px; transition: background 0.3s; margin: 5px; }
        .custom-file-upload:hover { opacity: 0.9; }
        
        .btn-secondary { background-color: white; color: var(--brand-blue); border: 1px solid var(--brand-blue); padding: 10px 20px; font-weight: 500; border-radius: 2px; cursor: pointer; margin: 5px; }
        .btn-secondary:hover { background-color: #f0f8ff; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 2rem; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
        
        .card-box { background: white; padding: 1.5rem; border-radius: 4px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; display: flex; justify-content: center; margin-bottom: 1rem; }
        .custom-legend { display: flex; justify-content: center; gap: 25px; margin-top: 15px; flex-wrap: wrap; }
        .legend-item { text-align: center; font-family: var(--font-legend); }
        .legend-color { width: 12px; height: 12px; display: inline-block; border-radius: 50%; margin-right: 6px; position: relative; top: 1px;}
        
        .filters-container { background: var(--bg-light); border-radius: 4px; margin-bottom: 1rem; border: 1px solid var(--border-color); overflow: hidden; padding: 1rem; }
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 10px; align-items: end; }
        .filter-select, .filter-input { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 100%; font-family: inherit; }
        
        .comments-list { background: white; border: 1px solid var(--border-color); border-radius: 4px; max-height: 500px; overflow-y: auto; }
        .comment-item { padding: 1rem; border-bottom: 1px solid var(--bg-light); display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .sentiment-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; }
        .sentiment-positive { background-color: var(--success); }
        .sentiment-neutral { background-color: var(--warning); color: #333; }
        .sentiment-negative { background-color: var(--danger); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 4px; width: 90%; max-width: 600px; border-top: 5px solid var(--brand-blue); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close { font-size: 1.5rem; font-weight: bold; cursor: pointer; color: #aaa; }
        
        #cardPreviewContainer, #previewAreaExt { display: flex; justify-content: center; margin-bottom: 1.5rem; padding: 20px; background-color: #e0e0e0; border-radius: 4px; min-height: 300px; align-items: center; }
        
        .social-card { 
            background: white; 
            width: 100%; 
            max-width: 450px; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            font-family: 'Roboto', sans-serif; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            text-align: left;
        }
        
        .social-card .card-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 25px 25px 10px 25px; }
        .social-card .card-icon { width: 24px; height: 24px; fill: var(--brand-blue); flex-shrink: 0; margin-right: 10px; }
        .social-card .card-icon-fa { font-size: 24px; color: var(--brand-blue); margin-right: 10px; }
        .social-card .card-date { font-size: 0.8rem; color: #999; margin-left: auto; white-space: nowrap; }

        .social-card .card-body { padding: 10px 25px 20px 25px; font-size: 1.1rem; line-height: 1.5; color: #222; flex-grow: 1; }
        
        .card-custom-image { width: 100%; height: auto; border-radius: 4px; margin-bottom: 15px; display: block; object-fit: cover; max-height: 250px; }

        .social-card .card-footer { 
            margin-top: auto; 
            border-top: 1px solid #eee; 
            padding: 15px 25px; 
            font-size: 0.9rem; 
            font-weight: 500; 
            color: var(--brand-blue); 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .social-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background-color: var(--brand-blue); }

        [contenteditable="true"] { cursor: text; border: 1px dashed transparent; transition: all 0.2s; min-width: 20px; display: inline-block; }
        [contenteditable="true"]:hover, [contenteditable="true"]:focus { background-color: rgba(237, 220, 1, 0.2); border-color: #999; border-radius: 3px; }
        .edit-hint { text-align: center; font-size: 0.85rem; color: #666; margin-bottom: 10px; font-style: italic; }

        .btn { border: none; padding: 8px 16px; font-size: 0.8rem; cursor: pointer; border-radius: 2px; font-weight: 500; text-transform: uppercase; transition: all 0.2s; }
        .btn-editor { background-color: var(--bg-light); color: var(--brand-blue); border: 1px solid var(--brand-blue); }
        .btn-editor:hover { background-color: var(--brand-blue); color: white; }
        .btn-download { background-color: var(--brand-yellow); color: var(--brand-blue); }
        .btn-copy { background-color: var(--brand-lightblue); color: white; }
        .btn-copy:hover { opacity: 0.9; }
        
        /* New Delete Button Style */
        .btn-danger { background-color: var(--bg-light); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background-color: var(--danger); color: white; }

        .btn-link { background: none; color: var(--brand-blue); text-decoration: underline; border: none; padding: 0; font-size: 0.9rem; cursor: pointer; }
        .btn-upload-img { background-color: #e2e6ea; color: #333; margin-right: 10px; }
        .btn-upload-img:hover { background-color: #dbe0e5; }
        
        .nav-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .toggle-group { display: flex; gap: 15px; margin-bottom: 10px; font-size: 0.9rem; flex-wrap: wrap; }
        .toggle-item { display: flex; align-items: center; gap: 5px; cursor: pointer; }

        .hidden { display: none !important; }

        /* Form Styles for Manual Entry */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .icon-fb path { fill: #1877F2; }
        .icon-ig path { fill: #E4405F; }
        .icon-tw path { fill: #000000; }
        
        footer { margin-top: auto; background-color: white; border-top: 1px solid var(--border-color); padding: 1rem 2rem; text-align: center; font-size: 0.8rem; color: #888; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>Social Sentiment Dashboard</h1>
    </div>
    <div class="header-actions">
        <button class="btn-header" onclick="exportFullState()"><i class="fas fa-save"></i> Salva Backup Completo</button>
        <label for="importFullStateInput" class="btn-header"><i class="fas fa-upload"></i> Ripristina Backup</label>
        <input type="file" id="importFullStateInput" accept=".json" style="display:none" onchange="importFullState(this)">
    </div>
</header>

<div class="tabs-nav">
    <button class="tab-button active" onclick="switchTab('proprietary')">Canali social proprietari</button>
    <button class="tab-button" onclick="switchTab('external')">Web e social esterni</button>
</div>

<main>
    <div id="tab-proprietary" class="tab-content active">
        <section class="upload-container">
            <h2 style="margin-bottom: 15px; color: var(--brand-blue);">Importazione Dati Proprietari</h2>
            <p style="margin-bottom: 20px; color: #666;">Carica file Excel (.xlsx) o CSV. Supporto multi-file.</p>
            <label for="fileInputProp" class="custom-file-upload" id="uploadLabelProp">Seleziona File</label>
            <input type="file" id="fileInputProp" accept=".xlsx, .xls, .csv" multiple>
            <p id="fileCountProp" style="margin-top: 10px; font-size: 0.9rem; color: var(--brand-blue);"></p>
        </section>

        <div id="appContentProp" class="hidden">
            <div class="dashboard-grid">
                <div class="card-box">
                    <h3 class="section-title">Sentiment Overview</h3>
                    <div style="margin-bottom: 1rem;"><strong>Totale Commenti:</strong> <span id="totalCommentsProp">0</span></div>
                    <div class="chart-wrapper">
                        <canvas id="sentimentChartProp"></canvas>
                    </div>
                    <div id="legendProp" class="custom-legend"></div>
                </div>
                
                <div class="card-box">
                    <h3 class="section-title" style="margin-bottom: 10px;">Feed Commenti</h3>
                    <div class="filters-container">
                        <div class="filter-row">
                            <div><label>Cerca</label><input type="text" id="filterTextProp" class="filter-input"></div>
                            <div>
                                <label>Sentiment</label>
                                <select id="filterSentimentProp" class="filter-select">
                                    <option value="all">Tutti</option>
                                    <option value="positive">Positivi</option>
                                    <option value="neutral">Neutri</option>
                                    <option value="negative">Negativi</option>
                                </select>
                            </div>
                            <div>
                                <label>Canale</label>
                                <select id="filterPlatformProp" class="filter-select">
                                    <option value="all">Tutti</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="instagram">Instagram</option>
                                    <option value="twitter">X (Twitter)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="comments-list" id="commentsListProp"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-external" class="tab-content">
        <section class="upload-container">
            <h2 style="margin-bottom: 15px; color: var(--brand-blue);">Importazione Web & Social Esterni</h2>
            <p style="margin-bottom: 20px; color: #666;">Carica Export Excel, Importa JSON integrativo o aggiungi manualmente.</p>
            
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;">
                <label for="fileInputExt" class="custom-file-upload" id="uploadLabelExt"><i class="fas fa-file-excel"></i> Carica Export Excel</label>
                <input type="file" id="fileInputExt" accept=".xlsx, .xls, .csv">
                
                <label for="importJsonExt" class="btn-secondary" style="display:inline-flex; align-items:center; gap:5px; height: 42px; margin-top:5px;">
                    <i class="fas fa-file-code"></i> Importa JSON
                </label>
                <input type="file" id="importJsonExt" accept=".json" style="display:none" onchange="importExtJSON(this)">
                
                <button class="btn-secondary" onclick="openManualModal()" style="height: 42px; margin-top:5px;">
                    <i class="fas fa-plus-circle"></i> Aggiungi Manuale
                </button>

                <button class="btn-secondary" onclick="exportExtJSON()" style="height: 42px; margin-top:5px;">
                    <i class="fas fa-download"></i> Esporta JSON (Integrazioni)
                </button>
            </div>
        </section>

        <div id="dashboardExt" class="dashboard-grid hidden">
            <div class="left-column">
                <div class="card-box" style="margin-bottom: 2rem;">
                    <h3 class="section-title">Sentiment Analysis</h3>
                    <div style="margin-bottom: 1rem;"><strong>Totale Contenuti:</strong> <span id="totalContentExt">0</span></div>
                    <div class="chart-wrapper">
                        <canvas id="sentimentChartExt"></canvas>
                    </div>
                    <div id="legendExt" class="custom-legend"></div>
                </div>
                <div class="card-box">
                    <h3 class="section-title">Canali e siti</h3>
                    <div class="chart-wrapper">
                        <canvas id="channelChartExt"></canvas>
                    </div>
                </div>
            </div>

            <div class="card-box">
                <h3 class="section-title">Editor Card Evoluto</h3>
                
                <div class="filters-container">
                    <div class="filter-row" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label><i class="fas fa-search"></i> Cerca nel testo</label>
                            <input type="text" id="searchExt" class="filter-input" placeholder="Cerca parole chiave o autori...">
                        </div>
                    </div>
                    
                    <div class="filter-row">
                        <div><label>Sentiment</label>
                            <select id="filterSentExt" class="filter-select">
                                <option value="all">Tutti</option>
                                <option value="positive">Positivi</option>
                                <option value="neutral">Neutri</option>
                                <option value="negative">Negativi</option>
                            </select>
                        </div>
                        <div><label>Canale</label>
                            <select id="filterChanExt" class="filter-select"><option value="all">Tutti</option></select>
                        </div>
                        <div><label>Ordina per</label>
                            <select id="sortExt" class="filter-select">
                                <option value="dateDesc">Data (Recenti)</option>
                                <option value="likesDesc">Engagement (Like/Reaz.)</option>
                                <option value="followersDesc">Followers (Alti)</option>
                                <option value="viewsDesc">Page Views</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="nav-controls">
                    <button id="prevExt" class="btn btn-editor"><i class="fas fa-chevron-left"></i></button>
                    <span id="counterExt">0 / 0</span>
                    <div style="display: flex; gap: 10px;">
                        <button id="delExt" class="btn btn-danger" title="Elimina Record Corrente"><i class="fas fa-trash-alt"></i></button>
                        <button id="nextExt" class="btn btn-editor"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <div class="toggle-group">
                    <label class="toggle-item"><input type="checkbox" id="showAuthorExt" checked> Mostra Autore</label>
                    <label class="toggle-item"><input type="checkbox" id="showOrigAuthorExt" checked> Mostra Fonte Orig.</label>
                    <label class="toggle-item"><input type="checkbox" id="showLikesExt" checked> Mostra Like</label>
                    <label class="toggle-item"><input type="checkbox" id="showFollowersExt" checked> Mostra Follower</label>
                </div>

                <div style="margin-bottom: 10px; display:flex; justify-content: flex-end; align-items:center;">
                    <label for="imgUploadExt" class="btn btn-upload-img" style="cursor:pointer;"><i class="fas fa-image"></i> Carica Immagine (o Incolla CTRL+V)</label>
                    <input type="file" id="imgUploadExt" accept="image/*" style="display:none;">
                    <a href="#" id="linkExt" target="_blank" class="btn-link">Apri Post Originale <i class="fas fa-external-link-alt"></i></a>
                </div>

                <p class="edit-hint"><i class="fas fa-pen"></i> Clicca sui testi dell'anteprima per modificarli</p>
                <div id="previewAreaExt">
                    </div>

                <div style="text-align: center; margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="copyBtnExt" class="btn btn-copy"><i class="fas fa-copy"></i> Copia Card</button>
                    <button id="dlBtnExt" class="btn btn-download"><i class="fas fa-download"></i> Scarica Card</button>
                </div>
            </div>
        </div>
    </div>
</main>

<footer>
    <span>Internal Use Only</span>
    <span class="app-version">v4.4 Prop. Duplicates Control</span>
</footer>

<div id="editorModalProp" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color: var(--brand-blue);">Editor Card Social</h2>
            <span class="close" id="closeModalProp">&times;</span>
        </div>
        <div style="margin-bottom: 1rem;">
            <input type="checkbox" id="toggleAuthorProp" checked> <label for="toggleAuthorProp">Mostra Nome Autore</label>
        </div>
        <div id="cardPreviewContainer">
            <div class="social-card" id="captureCardProp">
                <div class="card-header">
                    <div style="display:flex; align-items:center;">
                        <svg class="card-icon" id="cardIconProp" viewBox="0 0 24 24"><path d=""/></svg>
                    </div>
                    <span class="card-date" id="cardDateProp">DD/MM/YYYY</span>
                </div>
                <div class="card-body">
                    <div id="cardTextProp">Testo...</div>
                </div>
                <div class="card-footer">
                    <div id="cardAuthorProp">Nome Autore</div>
                    <div>Canale Proprietario</div>
                </div>
            </div>
        </div>
        <div style="text-align: right; margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn btn-copy" id="copyBtnProp"><i class="fas fa-copy"></i> Copia Card</button>
            <button class="btn btn-download" id="dlBtnProp"><i class="fas fa-download"></i> Scarica Card</button>
        </div>
    </div>
</div>

<div id="manualModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color: var(--brand-blue);">Aggiungi Post Manualmente</h2>
            <span class="close" onclick="closeManualModal()">&times;</span>
        </div>
        <div class="form-group">
            <label>Testo del Post *</label>
            <textarea id="manContent" rows="4"></textarea>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Data *</label>
                <input type="datetime-local" id="manDate">
            </div>
            <div class="form-group">
                <label>Canale / Sito *</label>
                <input type="text" id="manChannel" list="channelListHint" placeholder="Es. Facebook, Repubblica.it">
                <datalist id="channelListHint">
                    <option value="Facebook">
                    <option value="Instagram">
                    <option value="TikTok">
                    <option value="X (Twitter)">
                    <option value="LinkedIn">
                    <option value="YouTube">
                    <option value="Web/News">
                </datalist>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Autore</label>
                <input type="text" id="manAuthor" placeholder="Nome autore o pagina">
            </div>
            <div class="form-group">
                <label>Sentiment</label>
                <select id="manSentiment">
                    <option value="0">Neutro</option>
                    <option value="1">Positivo</option>
                    <option value="-1">Negativo</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Likes / Engagement</label>
                <input type="number" id="manLikes" value="0">
            </div>
            <div class="form-group">
                <label>Followers / Reach</label>
                <input type="number" id="manFollowers" value="0">
            </div>
        </div>
        <div class="form-group">
            <label>URL Originale</label>
            <input type="text" id="manUrl" placeholder="https://...">
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-download" onclick="saveManualPost()">Aggiungi al Dataset</button>
        </div>
    </div>
</div>

<script>
    // Register the plugin to ensure labels appear
    Chart.register(ChartDataLabels);

    // --- ICONS PATHS ---
    const icons = {
        facebook: "M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.15 5.96C15.21 5.96 16.12 6.04 16.12 6.04V8.51H15.01C13.77 8.51 13.38 9.28 13.38 10.07V12.06H16.15L15.71 14.96H13.38V21.96C18.16 21.21 21.82 17.06 21.82 12.06C21.82 6.53 17.32 2.04 12 2.04Z",
        instagram: "M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z",
        twitter: "M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z",
        default: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"
    };

    // --- UTILS ---
    function switchTab(name) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        document.querySelectorAll('.tab-button')[name === 'proprietary' ? 0 : 1].classList.add('active');
    }

    function formatCompactNumber(number) {
        if (!number || isNaN(number)) return "0";
        return Intl.NumberFormat('en-US', {
            notation: "compact",
            maximumFractionDigits: 1
        }).format(number);
    }

    function formatItalianDate(dateObj) {
        if (!dateObj || isNaN(dateObj.getTime())) return "N/D";
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = dateObj.getFullYear();
        const hours = String(dateObj.getHours()).padStart(2, '0');
        const minutes = String(dateObj.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    function dlCanvas(elementId) {
        const el = document.getElementById(elementId);
        const editables = el.querySelectorAll('[contenteditable="true"]');
        editables.forEach(e => e.setAttribute('contenteditable', 'false'));
        
        html2canvas(el, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `social-card-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            editables.forEach(e => e.setAttribute('contenteditable', 'true'));
        });
    }

    function copyCanvas(elementId, btnId) {
        const el = document.getElementById(elementId);
        const btn = document.getElementById(btnId);
        const originalText = btn.innerHTML;
        
        const editables = el.querySelectorAll('[contenteditable="true"]');
        editables.forEach(e => e.setAttribute('contenteditable', 'false'));

        html2canvas(el, { scale: 2 }).then(canvas => {
            canvas.toBlob(blob => {
                try {
                    const item = new ClipboardItem({ 'image/png': blob });
                    navigator.clipboard.write([item]).then(() => {
                        btn.innerHTML = '<i class="fas fa-check"></i> Copiato!';
                        setTimeout(() => btn.innerHTML = originalText, 2000);
                    });
                } catch (err) {
                    alert("Errore: Impossibile copiare negli appunti (usa HTTPS o Localhost)");
                    console.error(err);
                }
                editables.forEach(e => e.setAttribute('contenteditable', 'true'));
            });
        });
    }

    function generateHash(content, date, author) {
        // Create a simple signature string
        const str = (content + (date ? date.toISOString() : '') + author).toLowerCase().replace(/\s/g, '');
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return hash;
    }

    // --- PASTE LISTENER FOR IMAGES ---
    document.addEventListener('paste', function(e) {
        // Only active if we are in External tab (visible dashboard)
        if(document.getElementById('dashboardExt').classList.contains('hidden')) return;

        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentCardImage = event.target.result;
                    updateExtCard();
                    const btn = document.querySelector('label[for="imgUploadExt"]');
                    const orig = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Incollato!';
                    setTimeout(() => btn.innerHTML = orig, 1500);
                };
                reader.readAsDataURL(blob);
                e.preventDefault(); // Prevent default paste behavior
                break;
            }
        }
    });

    // ==========================================
    // LOGICA TAB 1: PROPRIETARI
    // ==========================================
    let propComments = [];
    let propChart = null;

    document.getElementById('fileInputProp').addEventListener('change', function(e) {
        const files = e.target.files;
        if(files.length === 0) return;
        
        let loaded = 0;
        let newBatchItems = []; // Accumulate items from this batch of files
        document.getElementById('uploadLabelProp').innerText = "Caricamento...";
        
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const workbook = XLSX.read(evt.target.result, {type: 'array'});
                    let sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('comment')) || workbook.SheetNames[0];
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {defval:""});
                    
                    json.forEach(row => {
                        if(row['Comment Message']) {
                            let d = new Date();
                            if(row['Created Time']) {
                                 if (typeof row['Created Time'] === 'number') {
                                    d = new Date((row['Created Time'] - (25567 + 2)) * 86400 * 1000);
                                 } else {
                                     d = new Date(row['Created Time']);
                                 }
                            }
                            let plat = 'other';
                            if(row['Comment Link']) {
                                if(row['Comment Link'].includes('facebook')) plat = 'facebook';
                                if(row['Comment Link'].includes('instagram')) plat = 'instagram';
                                if(row['Comment Link'].includes('twitter')) plat = 'twitter';
                            }
                            
                            const msg = row['Comment Message'];
                            const author = row['Comment User Name'] || 'Utente';
                            
                            newBatchItems.push({
                                msg: msg,
                                sent: row['Sentiment'] || 'Neutral',
                                date: d,
                                author: author,
                                platform: plat,
                                hash: generateHash(msg, d, author)
                            });
                        }
                    });
                } catch (err) {
                    console.error("Errore lettura file proprietario", err);
                }
                loaded++;
                if(loaded === files.length) {
                    handlePropDuplicateImport(newBatchItems);
                }
            };
            reader.readAsArrayBuffer(file);
        });
    });

    function handlePropDuplicateImport(newItems) {
        if(propComments.length === 0) {
            propComments = newItems;
        } else {
            const existingHashes = new Set(propComments.map(c => c.hash));
            let duplicateCount = 0;
            const uniqueNew = [];

            newItems.forEach(item => {
                if(existingHashes.has(item.hash)) {
                    duplicateCount++;
                } else {
                    uniqueNew.push(item);
                }
            });

            if(duplicateCount > 0) {
                if(confirm(`Trovati ${duplicateCount} duplicati nel file proprietario. Vuoi eliminare i doppioni (mantenendo i record esistenti) e importare solo i nuovi?`)) {
                    propComments = [...propComments, ...uniqueNew];
                } else {
                    propComments = [...propComments, ...newItems];
                }
            } else {
                propComments = [...propComments, ...newItems];
            }
        }
        initPropDashboard();
    }

    function initPropDashboard() {
        document.getElementById('uploadLabelProp').innerText = "Fatto!";
        document.getElementById('fileCountProp').innerText = `${propComments.length} commenti caricati.`;
        document.getElementById('appContentProp').classList.remove('hidden');
        updatePropUI();
    }

    ['filterTextProp', 'filterSentimentProp', 'filterPlatformProp'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePropUI);
    });

    function updatePropUI() {
        const txt = document.getElementById('filterTextProp').value.toLowerCase();
        const sent = document.getElementById('filterSentimentProp').value;
        const plat = document.getElementById('filterPlatformProp').value;

        const filtered = propComments.filter(c => {
            if(txt && !c.msg.toLowerCase().includes(txt)) return false;
            if(sent !== 'all' && !c.sent.toLowerCase().includes(sent)) return false;
            if(plat !== 'all' && c.platform !== plat) return false;
            return true;
        });

        document.getElementById('totalCommentsProp').innerText = filtered.length;
        renderPropList(filtered);
        renderPropChart(filtered);
    }

    function renderPropList(list) {
        const container = document.getElementById('commentsListProp');
        container.innerHTML = '';
        list.slice(0, 100).forEach((c, idx) => {
            let badge = 'sentiment-neutral';
            if(c.sent.toLowerCase().includes('positive')) badge = 'sentiment-positive';
            if(c.sent.toLowerCase().includes('negative')) badge = 'sentiment-negative';
            
            const div = document.createElement('div');
            div.className = 'comment-item';
            div.innerHTML = `
                <div>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">
                        <span class="sentiment-badge ${badge}">${c.sent}</span>
                        ${formatItalianDate(c.date)} - ${c.author}
                    </div>
                    <div>${c.msg.substring(0, 120)}...</div>
                </div>
                <button class="btn btn-editor" onclick="openPropModal(${propComments.indexOf(c)})">Editor</button>
            `;
            container.appendChild(div);
        });
    }

    function renderPropChart(list) {
        const ctx = document.getElementById('sentimentChartProp').getContext('2d');
        if(propChart) propChart.destroy();
        
        let counts = { Positive: 0, Neutral: 0, Negative: 0 };
        list.forEach(c => {
            let s = c.sent.toLowerCase();
            if(s.includes('positive')) counts.Positive++;
            else if(s.includes('negative')) counts.Negative++;
            else counts.Neutral++;
        });
        
        const total = list.length || 1;
        const percs = [
            Math.round(counts.Positive/total*100),
            Math.round(counts.Neutral/total*100),
            Math.round(counts.Negative/total*100)
        ];

        propChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Positivo', 'Neutro', 'Negativo'],
                datasets: [{
                    data: [counts.Positive, counts.Neutral, counts.Negative],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: {display: false}, datalabels: { display: false } }, 
                cutout: '60%' 
            }
        });

        document.getElementById('legendProp').innerHTML = `
            <div class="legend-item"><span class="legend-color" style="background:#28a745"></span>Positivo ${percs[0]}%</div>
            <div class="legend-item"><span class="legend-color" style="background:#ffc107"></span>Neutro ${percs[1]}%</div>
            <div class="legend-item"><span class="legend-color" style="background:#dc3545"></span>Negativo ${percs[2]}%</div>
        `;
    }

    const modalProp = document.getElementById('editorModalProp');
    function openPropModal(idx) {
        const c = propComments[idx];
        document.getElementById('cardTextProp').innerText = c.msg;
        document.getElementById('cardAuthorProp').innerText = c.author;
        document.getElementById('cardDateProp').innerText = formatItalianDate(c.date);
        
        const path = icons[c.platform] || icons.default;
        const svgPath = document.querySelector('#cardIconProp path');
        svgPath.setAttribute('d', path);
        
        if(c.platform === 'facebook') svgPath.style.fill = '#1877F2';
        else if(c.platform === 'instagram') svgPath.style.fill = '#E4405F';
        else if(c.platform === 'twitter') svgPath.style.fill = '#000000';
        else svgPath.style.fill = '#0146bc';

        modalProp.style.display = 'flex';
    }
    document.getElementById('closeModalProp').onclick = () => modalProp.style.display = 'none';
    document.getElementById('toggleAuthorProp').onchange = (e) => {
        document.getElementById('cardAuthorProp').style.display = e.target.checked ? 'block' : 'none';
    };
    document.getElementById('dlBtnProp').onclick = () => dlCanvas('captureCardProp');
    document.getElementById('copyBtnProp').onclick = () => copyCanvas('captureCardProp', 'copyBtnProp');


    // ==========================================
    // LOGICA TAB 2: ESTERNI
    // ==========================================
    let extData = [];
    let extFiltered = [];
    let extIdx = 0;
    let extCharts = {};
    let currentCardImage = null; // Per l'immagine manuale

    document.getElementById('fileInputExt').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        
        document.getElementById('uploadLabelExt').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisi in corso...';

        reader.onload = (evt) => {
            try {
                const wb = XLSX.read(evt.target.result, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const processed = processRawExtData(json);
                handleDuplicateImport(processed);
                document.getElementById('uploadLabelExt').innerHTML = '<i class="fas fa-check"></i> Fatto';
            } catch(err) {
                alert("Errore nella lettura del file. Verifica il formato.");
                console.error(err);
                document.getElementById('uploadLabelExt').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Errore';
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function processRawExtData(json) {
        return json.map(row => {
            // ROBUST DATE PARSING
            let rawDate = new Date();
            const pub = row['published'];
            if(pub) {
                if(typeof pub === 'number') {
                    // Excel serial date
                    rawDate = new Date((pub - (25567 + 2)) * 86400 * 1000);
                } else if(typeof pub === 'string') {
                    // Try parsing "YYYY-MM-DD HH:mm:ss" or similar
                    let d = new Date(pub);
                    // If invalid, try replacing common separators
                    if(isNaN(d.getTime())) {
                        d = new Date(pub.replace(/-/g, '/'));
                    }
                    if(!isNaN(d.getTime())) {
                        rawDate = d;
                    }
                }
            }
            
            let sourceRaw = row['source_type'] || 'WEB';
            let channel = 'Web/News';
            let iconClass = 'fas fa-globe';
            let isSocial = false; 
            
            if(sourceRaw.includes('TWITTER')) { channel = 'X (Twitter)'; iconClass = 'fab fa-twitter'; isSocial = true; }
            else if(sourceRaw.includes('FACEBOOK')) { channel = 'Facebook'; iconClass = 'fab fa-facebook'; isSocial = true; }
            else if(sourceRaw.includes('INSTAGRAM')) { channel = 'Instagram'; iconClass = 'fab fa-instagram'; isSocial = true; }
            else if(sourceRaw.includes('YOUTUBE')) { channel = 'YouTube'; iconClass = 'fab fa-youtube'; isSocial = true; }
            else if(sourceRaw.includes('LINKEDIN')) { channel = 'LinkedIn'; iconClass = 'fab fa-linkedin'; isSocial = true; }
            else if(sourceRaw.includes('BLUESKY')) { channel = 'BlueSky'; iconClass = 'fas fa-cloud'; isSocial = true; }
            else if(sourceRaw.includes('TIKTOK')) { channel = 'TikTok'; iconClass = 'fab fa-tiktok'; isSocial = true; }

            let rawAuthor = "Autore Sconosciuto";
            const name = row['extra_author_attributes.name'];
            const shortName = row['extra_author_attributes.short_name'];
            const sourceName = row['extra_source_attributes.name'];

            if (name && String(name).trim() !== "") rawAuthor = name;
            else if (shortName) rawAuthor = shortName;
            else if (sourceName) rawAuthor = sourceName;

            let displayAuthor = rawAuthor;
            let subAuthor = null; 

            if (!isSocial && row['host_url']) {
                let host = String(row['host_url']).trim();
                host = host.replace(/^https?:\/\//, '');
                host = host.replace(/^www\./, '');
                let parts = host.split('.');
                let mainPart = parts[0]; 
                
                if(mainPart.length > 0) {
                    mainPart = mainPart.charAt(0).toUpperCase() + mainPart.slice(1);
                    displayAuthor = mainPart;
                    subAuthor = rawAuthor; 
                }
            }

            let likes = parseInt(row['engagement'] || 0);
            
            // Logic for specific social followers
            let followers = 0;
            if (channel === 'Facebook') followers = row['source_extended_attributes.facebook_followers'];
            else if (channel.includes('X (Twitter)')) followers = row['source_extended_attributes.twitter_followers'];
            else if (channel === 'Instagram') followers = row['source_extended_attributes.instagram_followers'];
            else if (channel === 'YouTube') followers = row['source_extended_attributes.youtube_subscribers'] || row['source_extended_attributes.subscribers'];
            
            // Fallback
            if (!followers) followers = row['source_extended_attributes.followers'] || row['reach'] || 0;
            followers = parseInt(followers);
            
            let retweets = parseInt(row['article_extended_attributes.twitter_retweets'] || 0);
            
            let pvSem = parseInt(row['source_extended_attributes.semrush_pageviews'] || 0);
            let pvAle = parseInt(row['source_extended_attributes.alexa_pageviews'] || 0);
            let pageviews = Math.max(pvSem, pvAle);

            let sentVal = parseInt(row['sentiment'] || 0);
            let sentiment = 'Neutro';
            if(sentVal > 0) sentiment = 'Positivo';
            if(sentVal < 0) sentiment = 'Negativo';
            
            const content = row['content'] || row['title'] || '';

            return {
                date: rawDate,
                content: content,
                author: displayAuthor,
                subAuthor: subAuthor,
                channel: channel,
                isSocial: isSocial,
                iconClass: iconClass,
                likes: likes,
                followers: followers,
                retweets: retweets,
                pageviews: pageviews,
                sentimentVal: sentVal,
                sentiment: sentiment,
                mediaType: row['post_type'] || 'TEXT',
                url: row['url'] || '#',
                hash: generateHash(content, rawDate, displayAuthor)
            };
        });
    }

    function handleDuplicateImport(newItems) {
        if(extData.length === 0) {
            extData = newItems;
        } else {
            // Check for duplicates based on hash
            const existingHashes = new Set(extData.map(d => d.hash));
            const uniqueNew = [];
            let duplicateCount = 0;
            
            newItems.forEach(item => {
                if(existingHashes.has(item.hash)) {
                    duplicateCount++;
                } else {
                    uniqueNew.push(item);
                }
            });

            if(duplicateCount > 0) {
                if(confirm(`Trovati ${duplicateCount} duplicati nel file importato. Vuoi eliminare i doppioni (mantenendo i record esistenti) e importare solo i nuovi?`)) {
                    extData = [...extData, ...uniqueNew];
                } else {
                    // Import all anyway
                    extData = [...extData, ...newItems];
                }
            } else {
                extData = [...extData, ...newItems];
            }
        }
        
        refreshExtDashboard();
    }

    function refreshExtDashboard() {
        const channels = [...new Set(extData.map(d => d.channel))].sort();
        const sel = document.getElementById('filterChanExt');
        const currentVal = sel.value;
        sel.innerHTML = '<option value="all">Tutti</option>';
        channels.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            if(c === currentVal) opt.selected = true;
            sel.appendChild(opt);
        });

        document.getElementById('dashboardExt').classList.remove('hidden');
        updateExtUI();
    }

    // --- MANUAL ENTRY FUNCTIONS ---
    const manualModal = document.getElementById('manualModal');
    function openManualModal() {
        // Reset form
        document.getElementById('manContent').value = '';
        document.getElementById('manDate').value = new Date().toISOString().slice(0,16);
        document.getElementById('manChannel').value = '';
        document.getElementById('manAuthor').value = '';
        document.getElementById('manSentiment').value = "0";
        document.getElementById('manLikes').value = 0;
        document.getElementById('manFollowers').value = 0;
        document.getElementById('manUrl').value = '';
        manualModal.style.display = 'flex';
    }

    function closeManualModal() { manualModal.style.display = 'none'; }

    function saveManualPost() {
        const content = document.getElementById('manContent').value;
        const dateStr = document.getElementById('manDate').value;
        const channel = document.getElementById('manChannel').value;
        if(!content || !dateStr || !channel) {
            alert("Compila i campi obbligatori (Testo, Data, Canale)");
            return;
        }

        const date = new Date(dateStr);
        const author = document.getElementById('manAuthor').value || "Manuale";
        const sentVal = parseInt(document.getElementById('manSentiment').value);
        let sentiment = 'Neutro';
        if(sentVal > 0) sentiment = 'Positivo';
        if(sentVal < 0) sentiment = 'Negativo';

        let iconClass = 'fas fa-globe';
        let isSocial = false;
        const chLower = channel.toLowerCase();
        if(chLower.includes('facebook')) { iconClass = 'fab fa-facebook'; isSocial = true; }
        else if(chLower.includes('twitter') || chLower.includes(' x')) { iconClass = 'fab fa-twitter'; isSocial = true; }
        else if(chLower.includes('instagram')) { iconClass = 'fab fa-instagram'; isSocial = true; }
        else if(chLower.includes('linkedin')) { iconClass = 'fab fa-linkedin'; isSocial = true; }
        else if(chLower.includes('youtube')) { iconClass = 'fab fa-youtube'; isSocial = true; }
        else if(chLower.includes('tiktok')) { iconClass = 'fab fa-tiktok'; isSocial = true; }

        const newItem = {
            date: date,
            content: content,
            author: author,
            subAuthor: null,
            channel: channel,
            isSocial: isSocial,
            iconClass: iconClass,
            likes: parseInt(document.getElementById('manLikes').value) || 0,
            followers: parseInt(document.getElementById('manFollowers').value) || 0,
            retweets: 0,
            pageviews: 0,
            sentimentVal: sentVal,
            sentiment: sentiment,
            mediaType: 'TEXT',
            url: document.getElementById('manUrl').value || '#',
            hash: generateHash(content, date, author)
        };

        handleDuplicateImport([newItem]);
        closeManualModal();
    }

    // --- DELETE RECORD FUNCTION ---
    document.getElementById('delExt').onclick = function() {
        if(!extFiltered.length) return;
        if(!confirm("Sei sicuro di voler eliminare questo record dal database? L'operazione non  reversibile.")) return;

        const currentItem = extFiltered[extIdx];
        
        // Remove from main dataset
        extData = extData.filter(d => d !== currentItem);
        
        // Reset image if manually added
        currentCardImage = null;

        // If data is empty, hide dashboard or reset
        if(extData.length === 0) {
            document.getElementById('dashboardExt').classList.add('hidden');
            return;
        }

        // Refresh UI
        refreshExtDashboard();
    };

    // --- JSON EXPORT / IMPORT (INTEGRATION) ---
    function exportExtJSON() {
        if(extData.length === 0) { alert("Nessun dato da esportare"); return; }
        // Simple export of current external data
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(extData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href",     dataStr);
        downloadAnchorNode.setAttribute("download", "integration_export.json");
        document.body.appendChild(downloadAnchorNode); // required for firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importExtJSON(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                // Restore Date objects
                const processed = json.map(item => {
                    item.date = new Date(item.date);
                    return item;
                });
                handleDuplicateImport(processed);
                alert("Importazione JSON completata!");
            } catch(err) {
                console.error(err);
                alert("Errore file JSON");
            }
        };
        reader.readAsText(file);
    }

    // --- FULL STATE BACKUP ---
    function exportFullState() {
        const state = {
            proprietary: propComments,
            external: extData,
            timestamp: new Date()
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
        const link = document.createElement('a');
        link.href = dataStr;
        link.download = `full_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(link);
        link.click();
        link.remove();
    }

    function importFullState(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const state = JSON.parse(e.target.result);
                
                // Restore Prop
                if(state.proprietary) {
                    propComments = state.proprietary.map(c => ({...c, date: new Date(c.date)}));
                    initPropDashboard();
                }

                // Restore Ext
                if(state.external) {
                    extData = state.external.map(d => ({...d, date: new Date(d.date)}));
                    refreshExtDashboard();
                }
                
                alert("Backup ripristinato con successo!");
            } catch(err) {
                console.error(err);
                alert("Errore nel file di backup.");
            }
        };
        reader.readAsText(file);
    }


    // Event listeners
    ['filterSentExt', 'filterChanExt', 'sortExt'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateExtUI);
    });
    
    // Search input listener
    document.getElementById('searchExt').addEventListener('input', updateExtUI);

    ['showAuthorExt', 'showOrigAuthorExt', 'showLikesExt', 'showFollowersExt'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateExtCard);
    });

    document.getElementById('imgUploadExt').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                currentCardImage = evt.target.result;
                updateExtCard();
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    document.getElementById('prevExt').onclick = () => { extIdx--; currentCardImage = null; updateExtCard(); };
    document.getElementById('nextExt').onclick = () => { extIdx++; currentCardImage = null; updateExtCard(); };
    document.getElementById('dlBtnExt').onclick = () => dlCanvas('captureCardExt');
    document.getElementById('copyBtnExt').onclick = () => copyCanvas('captureCardExt', 'copyBtnExt');

    function updateExtUI() {
        const sFilter = document.getElementById('filterSentExt').value;
        const cFilter = document.getElementById('filterChanExt').value;
        const sort = document.getElementById('sortExt').value;
        const searchText = document.getElementById('searchExt').value.toLowerCase();

        extFiltered = extData.filter(d => {
            // Search Text Filter
            if (searchText && !d.content.toLowerCase().includes(searchText) && !d.author.toLowerCase().includes(searchText)) {
                return false;
            }

            let targetS = 'all';
            if(sFilter === 'positive') targetS = 'Positivo';
            if(sFilter === 'neutral') targetS = 'Neutro';
            if(sFilter === 'negative') targetS = 'Negativo';

            if(targetS !== 'all' && d.sentiment !== targetS) return false;
            if(cFilter !== 'all' && d.channel !== cFilter) return false;
            return true;
        });

        if(sort === 'dateDesc') extFiltered.sort((a,b) => b.date - a.date);
        if(sort === 'likesDesc') extFiltered.sort((a,b) => b.likes - a.likes);
        if(sort === 'followersDesc') extFiltered.sort((a,b) => b.followers - a.followers);
        if(sort === 'viewsDesc') extFiltered.sort((a,b) => b.pageviews - a.pageviews);

        // Update Total Count Label
        document.getElementById('totalContentExt').innerText = extFiltered.length;

        extIdx = 0;
        currentCardImage = null; // reset image on filter change
        updateExtCharts();
        updateExtCard();
    }

    function updateExtCharts() {
        const ctxS = document.getElementById('sentimentChartExt').getContext('2d');
        if(extCharts.sent) extCharts.sent.destroy();

        let counts = { Positivo: 0, Neutro: 0, Negativo: 0 };
        extFiltered.forEach(d => { counts[d.sentiment]++; });
        
        const total = extFiltered.length || 1;
        const percs = [
            Math.round(counts.Positivo/total*100),
            Math.round(counts.Neutro/total*100),
            Math.round(counts.Negativo/total*100)
        ];

        extCharts.sent = new Chart(ctxS, {
            type: 'doughnut',
            data: {
                labels: ['Positivo', 'Neutro', 'Negativo'],
                datasets: [{
                    data: [counts.Positivo, counts.Neutro, counts.Negativo],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: {display: false}, datalabels: { display: false } }, 
                cutout: '60%' 
            }
        });

        document.getElementById('legendExt').innerHTML = `
            <div class="legend-item"><span class="legend-color" style="background:#28a745"></span>Positivo ${percs[0]}%</div>
            <div class="legend-item"><span class="legend-color" style="background:#ffc107"></span>Neutro ${percs[1]}%</div>
            <div class="legend-item"><span class="legend-color" style="background:#dc3545"></span>Negativo ${percs[2]}%</div>
        `;

        // --- CHANNEL CHART ---
        const ctxC = document.getElementById('channelChartExt').getContext('2d');
        if(extCharts.chan) extCharts.chan.destroy();
        
        let chanCounts = {};
        extFiltered.forEach(d => { chanCounts[d.channel] = (chanCounts[d.channel]||0)+1; });
        
        // AGGREGATION LOGIC: Items < 10 go to "Altro"
        let aggregatedCounts = {};
        let otherCount = 0;
        
        for (let [channel, count] of Object.entries(chanCounts)) {
            if (count < 10) {
                otherCount += count;
            } else {
                aggregatedCounts[channel] = count;
            }
        }
        if (otherCount > 0) {
            aggregatedCounts['Altro'] = otherCount;
        }

        let sortedEntries = Object.entries(aggregatedCounts).sort((a,b) => b[1] - a[1]);
        let labels = sortedEntries.map(e => e[0]);
        let dataVals = sortedEntries.map(e => e[1]);

        const gradient = ctxC.createLinearGradient(0, 400, 0, 0); 
        gradient.addColorStop(0, '#b0c8f8'); 
        gradient.addColorStop(1, '#c5d5f8'); 

        extCharts.chan = new Chart(ctxC, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Post',
                    data: dataVals,
                    backgroundColor: gradient, 
                    borderRadius: 4,
                    barPercentage: 0.9, 
                    categoryPercentage: 0.9 
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        display: true, 
                        anchor: 'end',
                        align: 'end',
                        offset: 4,
                        color: '#666',
                        // Font Size Increase
                        font: { family: 'Avenir', weight: 'bold', size: 16 },
                        formatter: function(value) { return formatCompactNumber(value); } 
                    }
                },
                scales: {
                    x: { grid: { display: false } }, 
                    y: { display: false, grid: { display: false } } 
                },
                layout: { padding: { top: 25 } } 
            }
        });
    }

    function updateExtCard() {
        if(extIdx < 0) extIdx = 0;
        if(extIdx >= extFiltered.length) extIdx = Math.max(0, extFiltered.length - 1);
        
        document.getElementById('counterExt').innerText = extFiltered.length ? `${extIdx+1} / ${extFiltered.length}` : "0 / 0";
        const container = document.getElementById('previewAreaExt');
        
        if(!extFiltered.length) {
            container.innerHTML = "Nessun dato.";
            return;
        }

        const d = extFiltered[extIdx];
        const showAuthor = document.getElementById('showAuthorExt').checked;
        const showOrigAuthor = document.getElementById('showOrigAuthorExt').checked;
        const showLikes = document.getElementById('showLikesExt').checked;
        const showFollowers = document.getElementById('showFollowersExt').checked;

        // KPI Logic: Hide if < 50
        const actualShowLikes = showLikes && (d.likes >= 50);
        const actualShowFollowers = showFollowers && (d.followers >= 50);

        document.getElementById('linkExt').href = d.url;

        let followerLabel = d.isSocial ? 'Followers' : 'Audience';

        let iconHtml = `<i class="${d.iconClass} card-icon-fa"></i>`;
        if(d.channel.includes('X (Twitter)')) {
            iconHtml = `<svg class="card-icon" viewBox="0 0 24 24"><path d="${icons.twitter}"/></svg>`;
        }

        const imageHtml = currentCardImage ? `<img src="${currentCardImage}" class="card-custom-image">` : '';

        // Retweets display logic
        let retweetHtml = '';
        if (d.channel.includes('X') && actualShowLikes && d.retweets >= 50) {
             retweetHtml = `
                <div style="font-weight:bold; color:#17bf63; display:flex; align-items:center; gap:5px;">
                    <i class="fas fa-retweet"></i> ${formatCompactNumber(d.retweets)}
                </div>
             `;
        }

        container.innerHTML = `
            <div class="social-card" id="captureCardExt">
                <div class="card-header">
                    <div style="display:flex; align-items:center;">
                        ${iconHtml}
                        <span style="font-weight:bold; color:var(--brand-blue);" contenteditable="true">${d.channel}</span>
                    </div>
                    <span class="card-date" contenteditable="true">${formatItalianDate(d.date)}</span>
                </div>
                
                <div class="card-body">
                    ${imageHtml}
                    <div style="font-size:1.1rem; line-height:1.6;" contenteditable="true">${d.content.substring(0, 350)}${d.content.length>350?'...':''}</div>
                </div>
                
                <div class="card-footer">
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        ${showAuthor ? `<span style="font-weight:bold; font-size:1.3rem;" contenteditable="true">${d.author}</span>` : ''}
                        ${(d.subAuthor && showOrigAuthor) ? `<span style="font-size:0.85rem; color:#999;" contenteditable="true">${d.subAuthor}</span>` : ''}
                        ${actualShowFollowers ? `<span style="font-size:0.8rem; opacity:0.8; margin-top:3px;">${followerLabel}: ${formatCompactNumber(d.followers)}</span>` : ''}
                    </div>
                    
                    <div style="display:flex; gap:15px; align-items:center;">
                        ${retweetHtml}
                        ${actualShowLikes ? `
                        <div style="font-weight:bold; color:#e0245e; display:flex; align-items:center; gap:5px;">
                            <i class="fas fa-heart"></i> ${formatCompactNumber(d.likes)}
                        </div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }

</script>
</body>
</html>
