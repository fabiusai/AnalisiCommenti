<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Sentiment Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --brand-blue: #0146bc;
            --brand-yellow: #eddc01;
            --brand-lightblue: #63c2de;
            --text-dark: #333333;
            --text-light: #ffffff;
            --bg-light: #f4f6f9;
            --border-color: #dcdcdc;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --font-legend: 'Avenir Next LT Pro', 'Avenir Next', 'Avenir', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --font-main: 'Roboto', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: var(--font-main); background-color: var(--bg-light); color: var(--text-dark); display: flex; flex-direction: column; min-height: 100vh; }

        header { background-color: var(--brand-blue); color: var(--text-light); padding: 1rem 2rem; border-bottom: 5px solid var(--brand-yellow); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { font-size: 1.5rem; font-weight: 500; }
        
        .header-actions { display: flex; gap: 10px; }
        .btn-header { background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; transition: background 0.2s; }
        .btn-header:hover { background-color: rgba(255,255,255,0.4); }
        .btn-header-primary { background-color: var(--brand-yellow); color: var(--brand-blue); border: 1px solid var(--brand-yellow); font-weight: bold; }

        .tabs-nav { display: flex; background: white; padding: 0 2rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .tab-button { padding: 1rem 2rem; border: none; background: none; font-size: 1rem; font-weight: 500; color: var(--text-dark); cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-button:hover { background-color: #f0f0f0; }
        .tab-button.active { color: var(--brand-blue); border-bottom: 3px solid var(--brand-blue); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        main { flex: 1; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }
        
        .section-title { 
            font-size: 1.2rem; 
            color: var(--brand-blue); 
            margin-bottom: 0.5rem; 
            margin-top: 0;
            border-left: 6px solid var(--brand-yellow) !important; 
            padding-left: 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            line-height: 1.2;
            display: block;
        }

        .upload-container { background: white; padding: 2rem; border-radius: 4px; border: 1px solid var(--border-color); text-align: center; margin-bottom: 2rem; transition: border-color 0.3s; position: relative; }
        .upload-container:hover { border-color: var(--brand-blue); }
        input[type="file"] { display: none; }
        .custom-file-upload { display: inline-block; padding: 12px 24px; cursor: pointer; background-color: var(--brand-blue); color: white; font-weight: 500; border-radius: 2px; transition: background 0.3s; margin: 5px; }
        
        .btn-secondary { background-color: white; color: var(--brand-blue); border: 1px solid var(--brand-blue); padding: 10px 20px; font-weight: 500; border-radius: 2px; cursor: pointer; margin: 5px; }
        .btn-secondary:hover { background-color: #f0f8ff; }

        .btn { border: none; padding: 8px 16px; font-size: 0.8rem; cursor: pointer; border-radius: 2px; font-weight: 500; text-transform: uppercase; transition: all 0.2s; }
        .btn-download { background-color: var(--brand-yellow); color: var(--brand-blue); }
        .btn-copy { background-color: var(--brand-lightblue); color: white; }
        .btn-danger { background-color: white; color: var(--danger); border: 1px solid var(--danger); padding: 10px 20px; }
        .btn-danger:hover { background-color: var(--danger); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-sm { padding: 4px 8px; font-size: 0.7rem; margin-left: 5px; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #555; }
        .btn-outline:hover { background: #eee; }

        .btn-link { background: none; color: var(--brand-blue); text-decoration: underline; border: none; padding: 0; font-size: 0.9rem; cursor: pointer; }
        .btn-upload-img { background-color: #e2e6ea; color: #333; margin-right: 5px; padding: 5px 10px; border-radius: 4px; }
        
        .dashboard-grid { display: grid; grid-template-columns: 32% 68%; gap: 2rem; margin-bottom: 2rem; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
        
        .card-box { background: white; padding: 1.5rem; border-radius: 4px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative;}
        .chart-wrapper { position: relative; height: 300px; width: 100%; display: flex; justify-content: center; margin-bottom: 1rem; }
        
        .custom-legend { display: flex; justify-content: center; gap: 15px; margin-top: 10px; flex-wrap: nowrap; white-space: nowrap; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; }
        .legend-item { text-align: center; font-family: var(--font-legend); }
        .legend-color { width: 12px; height: 12px; display: inline-block; border-radius: 50%; margin-right: 4px; position: relative; top: 1px;}
        
        .filters-container { background: var(--bg-light); border-radius: 4px; margin-bottom: 1rem; border: 1px solid var(--border-color); overflow: hidden; padding: 1rem; }
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 10px; align-items: end; }
        .filter-select, .filter-input { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 100%; font-family: inherit; }
        
        .comments-list { background: white; border: 1px solid var(--border-color); border-radius: 4px; max-height: 500px; overflow-y: auto; }
        .comment-item { padding: 1rem; border-bottom: 1px solid var(--bg-light); display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; transition: background 0.2s; cursor: pointer; }
        .comment-item:hover { background-color: #f9f9f9; }
        
        .sentiment-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; display: inline-block; min-width: 60px; text-align: center;}
        .sentiment-positive { background-color: var(--success); }
        .sentiment-neutral { background-color: var(--warning); color: #333; }
        .sentiment-negative { background-color: var(--danger); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; border-radius: 4px; width: 90%; max-width: 650px; border-top: 5px solid var(--brand-blue); max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 1.5rem 2rem 1rem 2rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-tools-top { padding: 0 2rem 1rem 2rem; flex-shrink: 0; }
        .modal-footer-custom { padding: 1rem 2rem 1.5rem 2rem; flex-shrink: 0; text-align: right; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; margin-top: auto; }
        .close { font-size: 1.5rem; font-weight: bold; cursor: pointer; color: #aaa; }
        
        #cardPreviewContainer, #cardPreviewContainerExt { flex-grow: 1; overflow-y: auto; background-color: #e0e0e0; padding: 20px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; min-height: 200px; }
        
        .social-card { background: white; width: 100%; max-width: 450px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-family: 'Roboto', sans-serif; position: relative; overflow: hidden; display: flex; flex-direction: column; text-align: left; flex-shrink: 0; margin: auto; }
        .social-card .card-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 25px 25px 10px 25px; }
        .social-card .card-icon { width: 24px; height: 24px; fill: var(--brand-blue); flex-shrink: 0; margin-right: 10px; }
        .social-card .card-icon-fa { font-size: 24px; color: var(--brand-blue); margin-right: 10px; }
        .social-card .card-date { font-size: 0.8rem; color: #999; margin-left: auto; white-space: nowrap; }
        .social-card .card-body { padding: 10px 25px 20px 25px; font-size: 1.1rem; line-height: 1.5; color: #222; flex-grow: 1; }
        .card-custom-image { width: 100%; height: auto; border-radius: 4px; margin-bottom: 15px; display: block; object-fit: cover; max-height: 250px; }
        .social-card .card-footer { margin-top: auto; border-top: 1px solid #eee; padding: 15px 25px; font-size: 0.9rem; font-weight: 500; color: var(--brand-blue); display: flex; justify-content: space-between; align-items: center; }
        .social-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background-color: var(--brand-blue); }

        [contenteditable="true"] { cursor: text; border: 1px dashed transparent; transition: all 0.2s; min-width: 20px; display: inline-block; }
        [contenteditable="true"]:hover, [contenteditable="true"]:focus { background-color: rgba(237, 220, 1, 0.2); border-color: #999; border-radius: 3px; }

        .modal-nav-bar { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px; border: 1px solid #eee; }
        .modal-nav-btn { background: none; border: 1px solid #ccc; border-radius: 4px; padding: 5px 12px; cursor: pointer; }
        .modal-nav-btn:hover { background: #eee; }
        .nav-counter { font-size: 0.9rem; font-weight: 500; color: #555; background: #fff; padding: 6px 12px; border-radius: 15px; border: 1px solid #ddd; margin: 0 5px; }
        .hidden { display: none !important; }

        .sent-radio-group { display: inline-flex; background: #f0f0f0; border-radius: 20px; padding: 3px; gap: 2px; }
        .sent-radio-option { position: relative; margin: 0; }
        .sent-radio-option input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .sent-radio-option span { display: inline-block; padding: 4px 12px; border-radius: 16px; font-size: 0.85rem; font-weight: 500; color: #666; cursor: pointer; transition: all 0.2s; user-select: none; }
        .sent-radio-option:hover span { background: #e0e0e0; }
        .sent-radio-option input:checked + span { font-weight: bold; color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .sent-radio-option.opt-pos input:checked + span { background-color: var(--success); }
        .sent-radio-option.opt-neu input:checked + span { background-color: var(--warning); color: #333; }
        .sent-radio-option.opt-neg input:checked + span { background-color: var(--danger); }

        .modal-settings-bar { display: flex; gap: 15px; font-size: 0.9rem; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        footer { margin-top: auto; background-color: white; border-top: 1px solid var(--border-color); padding: 1rem 2rem; text-align: center; font-size: 0.8rem; color: #888; display: flex; justify-content: space-between; }
        
        .chart-toolbar-wrapper {
            background-color: var(--bg-light); 
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-toolbar {
            background-color: white;
            border-radius: 20px;
            padding: 5px 15px;
            display: inline-flex;
            gap: 10px;
            align-items: center;
            font-size: 0.85rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .chart-control { display: flex; align-items: center; gap: 5px; color: #666; }
        
        .chart-capture-zone { background: white; padding: 15px 10px; border-radius: 4px; }
        
        .counter-small { font-size: 0.7rem; color: #888; background: #eee; padding: 2px 6px; border-radius: 4px; float: right; margin-left: 10px; }
    </style>
</head>
<body>

<header>
    <h1>Social Sentiment Dashboard</h1>
    <div class="header-actions">
        <button class="btn-header btn-header-primary" onclick="saveToBrowser()"><i class="fas fa-cloud-upload-alt"></i> Salva nel Browser</button>
        <button class="btn-header" onclick="exportFullState()"><i class="fas fa-save"></i> Salva Backup File</button>
        <label for="importFullStateInput" class="btn-header"><i class="fas fa-upload"></i> Ripristina Backup</label>
        <input type="file" id="importFullStateInput" accept=".json" style="display:none" onchange="importFullState(this)">
    </div>
</header>

<div class="tabs-nav">
    <button class="tab-button active" onclick="switchTab('proprietary')">Canali social proprietari</button>
    <button class="tab-button" onclick="switchTab('external')">Web e social esterni</button>
</div>

<main>
    <div id="tab-proprietary" class="tab-content active">
        <section class="upload-container">
            <h2 style="margin-bottom: 15px; color: var(--brand-blue); border:none; padding:0;">Importazione Dati Proprietari</h2>
            <div style="display:flex; justify-content:center; gap:10px; align-items:center; flex-wrap:wrap;">
                <label for="fileInputProp" class="custom-file-upload" id="uploadLabelProp">Seleziona File</label>
                <input type="file" id="fileInputProp" accept=".xlsx, .xls, .csv" multiple>
                <button onclick="resetPropData()" class="btn btn-danger" style="margin-top: 5px;"><i class="fas fa-trash-alt"></i> Reset</button>
            </div>
            <p id="fileCountProp" style="margin-top: 10px; font-size: 0.9rem; color: var(--brand-blue);"></p>
        </section>

        <div id="appContentProp" class="hidden">
            <div class="dashboard-grid">
                <div class="card-box">
                    <div class="chart-toolbar-wrapper">
                        <div class="chart-toolbar">
                            <button class="btn btn-secondary btn-sm" onclick="copyChartData('sentimentProp')"><i class="fas fa-table"></i> Dati</button>
                            <button class="btn btn-outline btn-sm" onclick="downloadDivAsImage('export-sentimentProp', 'Sentiment_Proprietari')"><i class="fas fa-camera"></i> PNG</button>
                        </div>
                    </div>
                    <div id="export-sentimentProp" class="chart-capture-zone">
                        <h3 class="section-title">Sentiment Overview</h3>
                        <div style="margin-bottom: 1rem;"><strong>Totale Commenti:</strong> <span id="totalCommentsProp">0</span></div>
                        <div class="chart-wrapper"><canvas id="sentimentChartProp"></canvas></div>
                        <div id="legendProp" class="custom-legend"></div>
                    </div>
                </div>
                
                <div class="card-box">
                    <h3 class="section-title">Feed Commenti</h3>
                    <div class="filters-container">
                        <div class="filter-row">
                            <div><label>Cerca</label><input type="text" id="filterTextProp" class="filter-input"></div>
                            <div>
                                <label>Sentiment</label>
                                <select id="filterSentimentProp" class="filter-select">
                                    <option value="all">Tutti</option>
                                    <option value="positive">Positivi</option>
                                    <option value="neutral">Neutri</option>
                                    <option value="negative">Negativi</option>
                                </select>
                            </div>
                            <div>
                                <label>Canale</label>
                                <select id="filterPlatformProp" class="filter-select">
                                    <option value="all">Tutti</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="instagram">Instagram</option>
                                    <option value="twitter">X (Twitter)</option>
                                </select>
                            </div>
                            <div>
                                <label>Ordina per</label>
                                <select id="sortProp" class="filter-select">
                                    <option value="dateDesc">Pi√π Recenti</option>
                                    <option value="lengthDesc">Lunghezza (Max)</option>
                                    <option value="lengthAsc">Lunghezza (Min)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="comments-list" id="commentsListProp"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-external" class="tab-content">
        <section class="upload-container">
            <h2 style="margin-bottom: 15px; color: var(--brand-blue); border:none; padding:0;">Importazione Web & Social Esterni</h2>
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; align-items:center;">
                <label for="fileInputExt" class="custom-file-upload" id="uploadLabelExt"><i class="fas fa-file-excel"></i> Carica Export Excel</label>
                <input type="file" id="fileInputExt" accept=".xlsx, .xls, .csv">
                
                <label for="importJsonExt" class="btn-secondary" style="display:inline-flex; align-items:center; gap:5px; height: 42px; margin-top:5px;">
                    <i class="fas fa-file-code"></i> Importa JSON
                </label>
                <input type="file" id="importJsonExt" accept=".json" style="display:none" onchange="importExtJSON(this)">
                
                <button class="btn-secondary" onclick="openManualModal()" style="height: 42px; margin-top:5px;"><i class="fas fa-plus-circle"></i> Aggiungi Manuale</button>
                <button class="btn-secondary" onclick="exportExtJSON()" style="height: 42px; margin-top:5px;"><i class="fas fa-download"></i> Esporta JSON</button>
                <button onclick="resetExtData()" class="btn btn-danger" style="height: 42px; margin-top:5px;"><i class="fas fa-trash-alt"></i> Reset</button>
            </div>
        </section>

        <div id="dashboardExt" class="dashboard-grid hidden">
            <div class="left-column">
                <div class="card-box" style="margin-bottom: 2rem;">
                    <div class="chart-toolbar-wrapper">
                        <div class="chart-toolbar">
                            <button class="btn btn-secondary btn-sm" onclick="copyChartData('sentimentExt')"><i class="fas fa-table"></i> Dati</button>
                            <button class="btn btn-outline btn-sm" onclick="downloadDivAsImage('export-sentimentExt', 'Sentiment_Esterni')"><i class="fas fa-camera"></i> PNG</button>
                        </div>
                    </div>
                    <div id="export-sentimentExt" class="chart-capture-zone">
                        <h3 class="section-title">Sentiment Analysis</h3>
                        <div class="chart-wrapper"><canvas id="sentimentChartExt"></canvas></div>
                        <div id="legendExt" class="custom-legend"></div>
                    </div>
                </div>

                <div class="card-box" style="margin-bottom: 2rem;">
                    <div class="chart-toolbar-wrapper">
                        <div class="chart-toolbar">
                            <div class="chart-control">
                                <label for="threshChan">Soglia:</label>
                                <input type="number" id="threshChan" value="30" min="0" class="filter-input" style="width:60px; padding:2px 5px;">
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="copyChartData('channel')"><i class="fas fa-table"></i> Dati</button>
                            <button class="btn btn-outline btn-sm" onclick="downloadDivAsImage('export-channelExt', 'Canali_Esterni')"><i class="fas fa-camera"></i> PNG</button>
                        </div>
                    </div>
                    <div id="export-channelExt" class="chart-capture-zone">
                        <h3 class="section-title">Canali e siti</h3>
                        <div style="margin-bottom: 1rem;"><strong>Totale Contenuti:</strong> <span id="totalContentExt">0</span></div>
                        <div class="chart-wrapper"><canvas id="channelChartExt"></canvas></div>
                    </div>
                </div>

                <div class="card-box">
                    <div class="chart-toolbar-wrapper">
                        <div class="chart-toolbar">
                            <div class="chart-control">
                                <label for="threshEng">Soglia:</label>
                                <input type="number" id="threshEng" value="30" min="0" class="filter-input" style="width:60px; padding:2px 5px;">
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="copyChartData('engagement')"><i class="fas fa-table"></i> Dati</button>
                            <button class="btn btn-outline btn-sm" onclick="downloadDivAsImage('export-engagementExt', 'Engagement_Esterni')"><i class="fas fa-camera"></i> PNG</button>
                        </div>
                    </div>
                    <div id="export-engagementExt" class="chart-capture-zone">
                        <h3 class="section-title">Engagement & Like Totali</h3>
                        <div style="margin-bottom: 1rem;"><strong>Totale Like/Reazioni:</strong> <span id="totalLikesExt">0</span></div>
                        <div class="chart-wrapper"><canvas id="engagementChartExt"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="card-box">
                <h3 class="section-title">Feed Post & Commenti</h3>
                <div class="filters-container">
                    <div class="filter-row" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label><i class="fas fa-search"></i> Cerca nel testo</label>
                            <input type="text" id="searchExt" class="filter-input" placeholder="Cerca parole chiave o autori...">
                        </div>
                    </div>
                    <div class="filter-row">
                        <div><label>Sentiment</label>
                            <select id="filterSentExt" class="filter-select">
                                <option value="all">Tutti</option>
                                <option value="positive">Positivi</option>
                                <option value="neutral">Neutri</option>
                                <option value="negative">Negativi</option>
                            </select>
                        </div>
                        <div><label>Canale</label>
                            <select id="filterChanExt" class="filter-select"><option value="all">Tutti</option></select>
                        </div>
                        <div><label>Ordina per</label>
                            <select id="sortExt" class="filter-select">
                                <option value="dateDesc">Data (Recenti)</option>
                                <option value="lengthDesc">Lunghezza (Max)</option>
                                <option value="lengthAsc">Lunghezza (Min)</option>
                                <option value="likesDesc">Engagement</option>
                                <option value="followersDesc">Followers</option>
                                <option value="viewsDesc">Page Views</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="comments-list" id="commentsListExt"></div>
            </div>
        </div>
    </div>
</main>

<footer>
    <span>Internal Use Only</span>
    <span class="app-version">v6.15 Robust Import</span>
</footer>

<div id="editorModalProp" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color: var(--brand-blue);">Editor Card Social</h2>
            <span class="close" id="closeModalProp">&times;</span>
        </div>
        <div class="modal-tools-top">
            <div class="modal-nav-bar">
                <button class="modal-nav-btn" id="modalPrevProp"><i class="fas fa-chevron-left"></i> Prec</button>
                <div class="sent-radio-group">
                    <label class="sent-radio-option opt-pos"><input type="radio" name="sentProp" value="Positive"><span>üòä Pos</span></label>
                    <label class="sent-radio-option opt-neu"><input type="radio" name="sentProp" value="Neutral"><span>üòê Neu</span></label>
                    <label class="sent-radio-option opt-neg"><input type="radio" name="sentProp" value="Negative"><span>üò° Neg</span></label>
                </div>
                <span id="counterProp" class="nav-counter"></span>
                <button class="modal-nav-btn" id="modalNextProp">Succ <i class="fas fa-chevron-right"></i></button>
            </div>
            <div style="text-align:center;">
                <input type="checkbox" id="toggleAuthorProp" checked> <label for="toggleAuthorProp">Mostra Nome Autore</label>
                <button id="delProp" class="btn btn-danger" style="margin-left: 10px; padding: 4px 10px; font-size: 0.8rem;"><i class="fas fa-trash-alt"></i> Elimina</button>
            </div>
        </div>
        <div id="cardPreviewContainer">
            <div class="social-card" id="captureCardProp">
                <div class="card-header">
                    <div style="display:flex; align-items:center;">
                        <svg class="card-icon" id="cardIconProp" viewBox="0 0 24 24"><path d=""/></svg>
                    </div>
                    <span class="card-date" id="cardDateProp">DD/MM/YYYY</span>
                </div>
                <div class="card-body"><div id="cardTextProp" contenteditable="true">Testo...</div></div>
                <div class="card-footer"><div id="cardAuthorProp">Nome Autore</div></div>
            </div>
        </div>
        <div class="modal-footer-custom">
            <button class="btn btn-copy" id="copyBtnProp"><i class="fas fa-copy"></i> Copia Card</button>
            <button class="btn btn-download" id="dlBtnProp"><i class="fas fa-download"></i> Scarica Card</button>
        </div>
    </div>
</div>

<div id="editorModalExt" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color: var(--brand-blue);">Editor Card Esterni</h2>
            <span class="close" id="closeModalExt">&times;</span>
        </div>
        <div class="modal-tools-top">
            <div class="modal-nav-bar">
                <button class="modal-nav-btn" id="modalPrevExt"><i class="fas fa-chevron-left"></i> Prec</button>
                <div class="sent-radio-group">
                    <label class="sent-radio-option opt-pos"><input type="radio" name="sentExt" value="Positivo"><span>üòä Pos</span></label>
                    <label class="sent-radio-option opt-neu"><input type="radio" name="sentExt" value="Neutro"><span>üòê Neu</span></label>
                    <label class="sent-radio-option opt-neg"><input type="radio" name="sentExt" value="Negativo"><span>üò° Neg</span></label>
                </div>
                <span id="counterExt" class="nav-counter"></span>
                <button class="modal-nav-btn" id="modalNextExt">Succ <i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="modal-settings-bar">
                <label><input type="checkbox" id="showAuthorExt" checked> Autore</label>
                <label><input type="checkbox" id="showOrigAuthorExt" checked> Fonte</label>
                <label><input type="checkbox" id="showLikesExt" checked> Like</label>
                <label><input type="checkbox" id="showFollowersExt" checked> Follower</label>
            </div>
            <div style="text-align:center; margin-top:10px;">
                <label for="imgUploadExt" class="btn btn-upload-img" style="cursor:pointer; font-size:0.8rem;"><i class="fas fa-image"></i> Carica Immagine (o Incolla CTRL+V)</label>
                <input type="file" id="imgUploadExt" accept="image/*" style="display:none;">
                <button class="btn btn-secondary" onclick="manualSaveImage()" style="padding: 5px 10px;" title="Salva immagine corrente nel record"><i class="fas fa-save"></i></button>
                <button id="btnRemoveImg" class="btn btn-danger" style="display:none; padding: 5px 10px;" onclick="removeCardImage()"><i class="fas fa-trash"></i></button>
                
                <a href="#" id="linkExt" target="_blank" class="btn-link" style="margin-left:10px;">Apri Originale <i class="fas fa-external-link-alt"></i></a>
                <div style="margin-top:5px;">
                    <button id="editExt" class="btn btn-secondary" style="padding:4px 8px; font-size:0.75rem;" title="Modifica Dati Record"><i class="fas fa-edit"></i> Edit Dati</button>
                    <button id="delExt" class="btn btn-danger" style="padding:4px 8px; font-size:0.75rem;" title="Elimina Record"><i class="fas fa-trash-alt"></i> Elimina</button>
                </div>
            </div>
        </div>
        <div id="cardPreviewContainerExt"><div id="previewAreaExt"></div></div>
        <div class="modal-footer-custom">
            <button id="copyBtnExt" class="btn btn-copy"><i class="fas fa-copy"></i> Copia Card</button>
            <button id="dlBtnExt" class="btn btn-download"><i class="fas fa-download"></i> Scarica Card</button>
        </div>
    </div>
</div>

<div id="manualModal" class="modal">
    <div class="modal-content" style="overflow-y:auto; display:block;"> 
        <div class="modal-header">
            <h2 style="color: var(--brand-blue);">Dati Post</h2>
            <span class="close" onclick="closeManualModal()">&times;</span>
        </div>
        <div style="padding: 0 2rem 2rem 2rem;">
            <div class="form-group"><label>Testo del Post</label><textarea id="manContent" rows="4"></textarea></div>
            <div class="form-row">
                <div class="form-group"><label>Data</label><input type="datetime-local" id="manDate"></div>
                <div class="form-group"><label>Canale / Sito *</label><input type="text" id="manChannel" list="channelListHint" placeholder="Es. Facebook"><datalist id="channelListHint"><option value="Facebook"><option value="Instagram"><option value="TikTok"><option value="X (Twitter)"><option value="LinkedIn"><option value="YouTube"><option value="Web/News"></datalist></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Autore</label><input type="text" id="manAuthor" placeholder="Nome autore o pagina"></div>
                <div class="form-group"><label>Sentiment *</label>
                    <div class="sent-radio-group" style="width:100%; justify-content:center; background:white; border:1px solid #ddd;">
                       <label class="sent-radio-option opt-pos"><input type="radio" name="manSent" value="1"><span>Positivo</span></label>
                       <label class="sent-radio-option opt-neu"><input type="radio" name="manSent" value="0" checked><span>Neutro</span></label>
                       <label class="sent-radio-option opt-neg"><input type="radio" name="manSent" value="-1"><span>Negativo</span></label>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Likes / Engagement</label><input type="number" id="manLikes" value="0"></div>
                <div class="form-group"><label>Followers / Reach</label><input type="number" id="manFollowers" value="0"></div>
            </div>
            <div class="form-group"><label>URL Originale *</label><input type="text" id="manUrl" placeholder="https://..." oninput="checkUrlDuplicate()"><small id="urlWarning" style="color: var(--danger); display: none; font-weight: bold; margin-top: 5px;"></small></div>
            <div style="text-align: right; margin-top: 20px;"><button class="btn btn-download" id="saveManualBtn" onclick="saveManualPost()">Aggiungi al Dataset</button></div>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    
    // FORMATTAZIONE NUMERI ITALIANA (Virgola e K/M semplificato)
    function formatNumberIT(num) {
         if (!num || isNaN(num)) return "0";
         if (num > 199) {
             if (num >= 1000000) return (num / 1000000).toFixed(2).replace('.', ',') + 'M';
             if (num >= 1000) return (num / 1000).toFixed(2).replace('.', ',') + 'K';
         }
         return num.toString().replace('.', ',');
    }

    const icons = {
        facebook: "M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.15 5.96C15.21 5.96 16.12 6.04 16.12 6.04V8.51H15.01C13.77 8.51 13.38 9.28 13.38 10.07V12.06H16.15L15.71 14.96H13.38V21.96C18.16 21.21 21.82 17.06 21.82 12.06C21.82 6.53 17.32 2.04 12 2.04Z",
        instagram: "M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z",
        twitter: "M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z",
        default: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"
    };
    
    const brandColors = {
        'Facebook': '#1877F2',
        'Instagram': '#E1306C',
        'X (Twitter)': '#000000',
        'Twitter': '#1DA1F2',
        'LinkedIn': '#0077b5',
        'YouTube': '#FF0000',
        'TikTok': '#000000',
        'Web/News': '#808080',
        'Altro': '#555555'
    };

    const brandIconsUnicode = {
        'Facebook': '\uf09a', 
        'Instagram': '\uf16d', 
        'X (Twitter)': '\ue61b', 
        'Twitter': '\uf099',
        'LinkedIn': '\uf0e1',
        'YouTube': '\uf167',
        'TikTok': '\ue07b',
        'Web/News': '\uf0ac',
        'Altro': '\uf141'
    };

    function getBrandColor(channel) {
        return brandColors[channel] || '#b0c8f8';
    }

    function switchTab(name) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        document.querySelectorAll('.tab-button')[name === 'proprietary' ? 0 : 1].classList.add('active');
    }

    function formatItalianDate(d) {
        if (!d || isNaN(d.getTime())) return "N/D";
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        return `${day}/${month}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function smartTruncate(text, maxLen) {
        if (!text) return "";
        if (text.length <= maxLen) return text;
        const sub = text.substring(0, maxLen);
        const lastDot = sub.lastIndexOf('.');
        if (lastDot !== -1) return sub.substring(0, lastDot + 1); 
        const lastSpace = sub.lastIndexOf(' ');
        if (lastSpace !== -1) return sub.substring(0, lastSpace) + '...';
        return sub + '...';
    }

    function dlCanvas(id) {
        const el = document.getElementById(id);
        const btnId = id === 'captureCardProp' ? 'dlBtnProp' : 'dlBtnExt';
        const btn = document.getElementById(btnId);
        const origText = btn.innerHTML;

        const editables = el.querySelectorAll('[contenteditable="true"]');
        editables.forEach(e => e.setAttribute('contenteditable', 'false'));
        html2canvas(el, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `card-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            editables.forEach(e => e.setAttribute('contenteditable', 'true'));
            btn.innerHTML = '<i class="fas fa-check"></i> Salvato!';
            setTimeout(() => btn.innerHTML = origText, 2000);
        });
    }
    
    function downloadDivAsImage(divId, filenamePrefix) {
        const el = document.getElementById(divId);
        html2canvas(el, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `${filenamePrefix}-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }
    
    function downloadChart(chartId) {
        const c = document.getElementById(chartId);
        const link = document.createElement('a');
        link.download = `grafico-${Date.now()}.png`;
        link.href = c.toDataURL('image/png', 1.0);
        link.click();
    }

    function copyChartData(type) {
        if (type === 'sentimentProp' || type === 'sentimentExt') {
            const isProp = type === 'sentimentProp';
            const list = isProp ? propFiltered : extFiltered;
            if(!list || list.length === 0) return alert("Nessun dato");
            let sCounts = { Pos: 0, Neu: 0, Neg: 0 };
            list.forEach(i => {
                let sent = isProp ? i.sent : i.sentiment; 
                if (sent.toLowerCase().includes('positive') || sent === 'Positivo') sCounts.Pos++;
                else if (sent.toLowerCase().includes('negative') || sent === 'Negativo') sCounts.Neg++;
                else sCounts.Neu++;
            });
            let output = "Sentiment\tValore\n";
            output += `Positivo\t${sCounts.Pos}\nNeutro\t${sCounts.Neu}\nNegativo\t${sCounts.Neg}\n`;
            navigator.clipboard.writeText(output).then(() => alert("Dati copiati!"), () => alert("Errore copia"));
            return;
        }

        if(!extFiltered || extFiltered.length === 0) return alert("Nessun dato disponibile");
        let output = "";
        
        if (type === 'channel') {
            const threshold = parseInt(document.getElementById('threshChan').value) || 0;
            let cCounts = {};
            extFiltered.forEach(d => cCounts[d.channel] = (cCounts[d.channel]||0)+1);
            let agg = [];
            let other = 0;
            Object.entries(cCounts).forEach(([k, v]) => {
                if(v < threshold) other += v; else agg.push([k,v]);
            });
            if(other > 0) agg.push(['Altro', other]);
            agg.sort((a,b) => b[1] - a[1]);
            output = "Canale\tNumero Contenuti\n";
            agg.forEach(([k, v]) => output += `${k}\t${v}\n`);
            
        } else if (type === 'engagement') {
            const threshold = parseInt(document.getElementById('threshEng').value) || 0;
            let lCounts = {};
            extFiltered.forEach(d => {
                if(d.channel !== 'Web/News') { 
                    lCounts[d.channel] = (lCounts[d.channel]||0) + d.likes;
                }
            });
            let agg = [];
            let other = 0;
            Object.entries(lCounts).forEach(([k, v]) => {
                if(v < threshold) other += v; else agg.push([k,v]);
            });
            if(other > 0) agg.push(['Altro', other]);
            agg.sort((a,b) => b[1] - a[1]);
            output = "Canale\tLike Totali\n";
            agg.forEach(([k, v]) => output += `${k}\t${v}\n`);
        }

        navigator.clipboard.writeText(output).then(() => {
            alert("Dati copiati negli appunti! Puoi incollarli in Excel.");
        }, () => {
            alert("Errore nella copia. Verifica i permessi.");
        });
    }

    function copyCanvas(id, btnId) {
        const el = document.getElementById(id);
        const btn = document.getElementById(btnId);
        const origText = btn.innerHTML;
        const editables = el.querySelectorAll('[contenteditable="true"]');
        editables.forEach(e => e.setAttribute('contenteditable', 'false'));
        html2canvas(el, { scale: 2 }).then(canvas => {
            canvas.toBlob(blob => {
                try {
                    navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).then(() => {
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => btn.innerHTML = origText, 2000);
                    });
                } catch (e) { alert("Errore copia (usa HTTPS/Localhost)"); }
                editables.forEach(e => e.setAttribute('contenteditable', 'true'));
            });
        });
    }

    function generateHash(c, d, a) {
        const str = (c + (d ? d.toISOString() : '') + a).toLowerCase().replace(/\s/g, '');
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = ((hash << 5) - hash) + str.charCodeAt(i);
            hash |= 0;
        }
        return hash;
    }

    const STORAGE_KEY = 'socialDashState';
    function saveToBrowser() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ prop: propComments, ext: extData, ts: new Date() }));
            alert("Salvato!");
        } catch (e) { alert("Errore salvataggio (Memoria Piena?)"); }
    }
    
    window.addEventListener('load', () => {
        const s = localStorage.getItem(STORAGE_KEY);
        if(s && confirm("Trovati dati salvati. Ripristinare?")) {
            const p = JSON.parse(s);
            if(p.prop) { propComments = p.prop.map(x=>({...x, date: new Date(x.date)})); initPropDashboard(); }
            if(p.ext) { extData = p.ext.map(x=>({...x, date: new Date(x.date)})); refreshExtDashboard(); }
        }
    });

    document.addEventListener('paste', function(e) {
        const extModal = document.getElementById('editorModalExt');
        if(extModal.style.display !== 'block' && extModal.style.display !== 'flex') return;
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    currentCardImage = ev.target.result;
                    if(isEditing && editTargetItem) editTargetItem.customImage = currentCardImage;
                    updateExtCard();
                    const btn = document.querySelector('label[for="imgUploadExt"]');
                    btn.innerHTML = '<i class="fas fa-check"></i> Incollato!';
                    setTimeout(() => btn.innerHTML = '<i class="fas fa-image"></i> Carica Immagine (o Incolla CTRL+V)', 1500);
                };
                reader.readAsDataURL(items[i].getAsFile());
                e.preventDefault(); break;
            }
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.target.matches('input, textarea') || e.target.isContentEditable) return;
        if (document.getElementById('editorModalProp').style.display === 'flex') {
            if (e.key === 'ArrowLeft') { if (currentPropIdx > 0) openPropModal(currentPropIdx - 1); } 
            else if (e.key === 'ArrowRight') { if (currentPropIdx < propFiltered.length - 1) openPropModal(currentPropIdx + 1); }
        } else if (document.getElementById('editorModalExt').style.display === 'flex') {
            if (e.key === 'ArrowLeft') { if (extIdx > 0) openExtModal(extIdx - 1); } 
            else if (e.key === 'ArrowRight') { if (extIdx < extFiltered.length - 1) openExtModal(extIdx + 1); }
        }
    });

    let propComments = [], propFiltered = [], propChart = null, currentPropIdx = 0;

    document.getElementById('fileInputProp').addEventListener('change', function(e) {
        const f = e.target.files;
        if(!f.length) return;
        let loaded = 0, batch = [];
        Array.from(f).forEach(file => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const wb = XLSX.read(evt.target.result, {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
                    json.forEach(row => {
                        if(row['Comment Message']) {
                            let d = new Date();
                            if(row['Created Time']) d = typeof row['Created Time'] === 'number' ? new Date((row['Created Time'] - 25569) * 86400 * 1000) : new Date(row['Created Time']);
                            let plat = 'other';
                            if(row['Comment Link']) {
                                if(row['Comment Link'].includes('facebook')) plat = 'facebook';
                                else if(row['Comment Link'].includes('instagram')) plat = 'instagram';
                                else if(row['Comment Link'].includes('twitter')) plat = 'twitter';
                            }
                            batch.push({
                                msg: row['Comment Message'], sent: row['Sentiment'] || 'Neutral',
                                date: d, author: row['Comment User Name'] || 'Utente', platform: plat,
                                hash: generateHash(row['Comment Message'], d, row['Comment User Name'])
                            });
                        }
                    });
                } catch (e) { console.error(e); }
                loaded++;
                if(loaded === f.length) handlePropImport(batch);
            };
            reader.readAsArrayBuffer(file);
        });
    });

    function handlePropImport(newItems) {
        if(!propComments.length) propComments = newItems;
        else {
            const hashes = new Set(propComments.map(c => c.hash));
            const unique = newItems.filter(i => !hashes.has(i.hash));
            propComments = [...propComments, ...unique];
        }
        initPropDashboard();
    }

    function initPropDashboard() {
        document.getElementById('fileCountProp').innerText = `${propComments.length} commenti caricati.`;
        document.getElementById('appContentProp').classList.remove('hidden');
        updatePropUI();
    }

    function resetPropData() {
        if(confirm("Reset Proprietari?")) {
            propComments = []; propFiltered = [];
            document.getElementById('appContentProp').classList.add('hidden');
            document.getElementById('fileInputProp').value = '';
            document.getElementById('fileCountProp').innerText = '';
            localStorage.removeItem(STORAGE_KEY);
        }
    }

    ['filterTextProp', 'filterSentimentProp', 'filterPlatformProp', 'sortProp'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', updatePropUI);
    });

    function updatePropUI() {
        const txt = document.getElementById('filterTextProp').value.toLowerCase();
        const sent = document.getElementById('filterSentimentProp').value;
        const plat = document.getElementById('filterPlatformProp').value;
        const sort = document.getElementById('sortProp').value;

        propFiltered = propComments.filter(c => {
            if(txt && !c.msg.toLowerCase().includes(txt)) return false;
            if(sent !== 'all' && !c.sent.toLowerCase().includes(sent)) return false;
            if(plat !== 'all' && c.platform !== plat) return false;
            return true;
        });

        if(sort === 'dateDesc') propFiltered.sort((a,b) => b.date - a.date);
        else if(sort === 'lengthDesc') propFiltered.sort((a,b) => b.msg.length - a.msg.length);
        else if(sort === 'lengthAsc') propFiltered.sort((a,b) => a.msg.length - b.msg.length);

        document.getElementById('totalCommentsProp').innerText = formatNumberIT(propFiltered.length);
        renderPropList(propFiltered);
        renderPropChart(propFiltered);
    }

    function renderPropList(list) {
        const cont = document.getElementById('commentsListProp');
        cont.innerHTML = '';
        list.forEach((c, idx) => {
            let badge = c.sent.toLowerCase().includes('positive') ? 'sentiment-positive' : (c.sent.toLowerCase().includes('negative') ? 'sentiment-negative' : 'sentiment-neutral');
            const d = document.createElement('div');
            d.className = 'comment-item';
            d.onclick = () => openPropModal(idx);
            d.innerHTML = `<div>
                <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">
                    <span class="sentiment-badge ${badge}">${c.sent}</span>
                    <span style="margin-left:8px;">${formatItalianDate(c.date)} - <strong>${c.author}</strong></span>
                    <span class="counter-small">${idx + 1} di ${list.length}</span>
                </div>
                <div style="margin-top:5px;">${c.msg.substring(0, 120)}...</div>
            </div>`;
            cont.appendChild(d);
        });
    }

    function renderPropChart(list) {
        const ctx = document.getElementById('sentimentChartProp').getContext('2d');
        if(propChart) propChart.destroy();
        let c = { Positive: 0, Neutral: 0, Negative: 0 };
        list.forEach(i => {
            let s = i.sent.toLowerCase();
            if(s.includes('positive')) c.Positive++; else if(s.includes('negative')) c.Negative++; else c.Neutral++;
        });
        const tot = list.length || 1;
        propChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: ['Positivo', 'Neutro', 'Negativo'], datasets: [{ data: [c.Positive, c.Neutral, c.Negative], backgroundColor: ['#28a745', '#ffc107', '#dc3545'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}, datalabels: {display: false} }, cutout: '60%' }
        });
        document.getElementById('legendProp').innerHTML = `
            <div class="legend-item"><span class="legend-color" style="background:#28a745"></span>Positivo ${Math.round(c.Positive/tot*100)}%</div>
            <div class="legend-item"><span class="legend-color" style="background:#ffc107"></span>Neutro ${Math.round(c.Neutral/tot*100)}%</div>
            <div class="legend-item"><span class="legend-color" style="background:#dc3545"></span>Negativo ${Math.round(c.Negative/tot*100)}%</div>
        `;
    }

    const modalProp = document.getElementById('editorModalProp');
    function openPropModal(idx) {
        currentPropIdx = idx;
        const c = propFiltered[idx];
        document.getElementById('cardTextProp').innerText = smartTruncate(c.msg, 550); 
        document.getElementById('cardAuthorProp').innerText = c.author;
        document.getElementById('cardDateProp').innerText = formatItalianDate(c.date);
        document.getElementById('counterProp').innerText = `${propFiltered.length - idx}`;
        let val = 'Neutral';
        if(c.sent.toLowerCase().includes('positive')) val = 'Positive';
        else if(c.sent.toLowerCase().includes('negative')) val = 'Negative';
        const r = document.querySelector(`input[name="sentProp"][value="${val}"]`);
        if(r) r.checked = true;
        const p = document.querySelector('#cardIconProp path');
        p.setAttribute('d', icons[c.platform] || icons.default);
        p.style.fill = c.platform === 'facebook' ? '#1877F2' : (c.platform === 'instagram' ? '#E4405F' : (c.platform === 'twitter' ? '#000000' : '#0146bc'));
        modalProp.style.display = 'flex';
    }

    document.getElementById('closeModalProp').onclick = () => modalProp.style.display = 'none';
    document.getElementById('modalPrevProp').onclick = () => { if(currentPropIdx > 0) openPropModal(currentPropIdx - 1); };
    document.getElementById('modalNextProp').onclick = () => { if(currentPropIdx < propFiltered.length - 1) openPropModal(currentPropIdx + 1); };
    document.querySelectorAll('input[name="sentProp"]').forEach(r => {
        r.addEventListener('change', (e) => {
            if(!propFiltered.length) return;
            propFiltered[currentPropIdx].sent = e.target.value;
            updatePropUI();
            e.target.blur(); 
        });
    });
    document.getElementById('toggleAuthorProp').onchange = (e) => document.getElementById('cardAuthorProp').style.display = e.target.checked ? 'block' : 'none';
    document.getElementById('dlBtnProp').onclick = () => dlCanvas('captureCardProp');
    document.getElementById('copyBtnProp').onclick = () => copyCanvas('captureCardProp', 'copyBtnProp');
    document.getElementById('delProp').onclick = () => {
        if(!confirm("Eliminare definitivamente questo commento?")) return;
        const itemToDelete = propFiltered[currentPropIdx];
        propComments = propComments.filter(x => x !== itemToDelete);
        updatePropUI();
        if(propFiltered.length > 0) {
            if(currentPropIdx >= propFiltered.length) currentPropIdx = propFiltered.length - 1;
            openPropModal(currentPropIdx);
        } else {
            modalProp.style.display = 'none';
        }
    };


    let extData = [], extFiltered = [], extIdx = 0, extCharts = {}, currentCardImage = null, isEditing = false, editTargetItem = null;

    document.getElementById('fileInputExt').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const wb = XLSX.read(evt.target.result, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                handleExtImport(json.map(processExtRow));
            } catch(e) { alert("Errore file"); }
        };
        reader.readAsArrayBuffer(file);
    });

    function processExtRow(row) {
        let d = new Date();
        if(row['published']) {
            if(typeof row['published'] === 'number') d = new Date((row['published'] - 25569) * 86400 * 1000);
            else d = new Date(row['published'].replace(/-/g, '/'));
        }
        let src = row['source_type'] || 'WEB', chan = 'Web/News', icon = 'fas fa-globe', isSoc = false;
        if(src.includes('TWITTER')) { chan='X (Twitter)'; icon='fab fa-twitter'; isSoc=true; }
        else if(src.includes('FACEBOOK')) { chan='Facebook'; icon='fab fa-facebook'; isSoc=true; }
        else if(src.includes('INSTAGRAM')) { chan='Instagram'; icon='fab fa-instagram'; isSoc=true; }
        else if(src.includes('YOUTUBE')) { chan='YouTube'; icon='fab fa-youtube'; isSoc=true; }
        
        let aut = row['extra_author_attributes.name'] || row['extra_author_attributes.short_name'] || row['extra_source_attributes.name'] || "Autore Sconosciuto";
        let subAut = null;
        if(!isSoc && row['host_url']) {
            let h = row['host_url'].replace(/^https?:\/\//, '').replace(/^www\./, '').split('.')[0];
            if(h) { aut = h.charAt(0).toUpperCase() + h.slice(1); subAut = row['extra_author_attributes.name']; }
        }

        let likes = parseInt(row['engagement'] || 0);
        let foll = parseInt(row['source_extended_attributes.followers'] || row['reach'] || 0);
        if(chan==='Facebook') foll = row['source_extended_attributes.facebook_followers'];

        let sentVal = parseInt(row['sentiment'] || 0);
        let sent = sentVal > 0 ? 'Positivo' : (sentVal < 0 ? 'Negativo' : 'Neutro');

        return {
            date: d, content: row['content'] || row['title'] || '', author: aut, subAuthor: subAut,
            channel: chan, isSocial: isSoc, iconClass: icon, likes: likes, followers: parseInt(foll||0),
            sentiment: sent, sentimentVal: sentVal, url: row['url'] || '#',
            hash: generateHash(row['content']||'', d, aut),
            customImage: null 
        };
    }

    // MODIFICA CRUCIALE PER GESTIRE I BACKUP COME IMPORT
    function handleExtImport(items) {
        if(!extData.length) extData = items;
        else {
            const hashes = new Set(extData.map(i => i.hash));
            extData = [...extData, ...items.filter(i => !hashes.has(i.hash))];
        }
        refreshExtDashboard();
    }

    function refreshExtDashboard() {
        const s = document.getElementById('filterChanExt');
        const currentSelection = s.value;
        
        s.innerHTML = '<option value="all">Tutti</option>';
        [...new Set(extData.map(d => d.channel))].sort().forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`);
        
        if(currentSelection && [...s.options].some(o => o.value === currentSelection)) {
            s.value = currentSelection;
        }

        document.getElementById('dashboardExt').classList.remove('hidden');
        updateExtUI();
    }

    function resetExtData() {
        if(confirm("Reset Esterni?")) {
            extData = []; extFiltered = [];
            document.getElementById('dashboardExt').classList.add('hidden');
            document.getElementById('fileInputExt').value = '';
            localStorage.removeItem(STORAGE_KEY);
        }
    }

    ['filterSentExt', 'filterChanExt', 'sortExt', 'searchExt', 'threshChan', 'threshEng'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener(id === 'searchExt' || id.startsWith('thresh') ? 'input' : 'change', 
            id.startsWith('thresh') ? renderExtCharts : updateExtUI);
    });

    function updateExtUI() {
        const sent = document.getElementById('filterSentExt').value;
        const chan = document.getElementById('filterChanExt').value;
        const txt = document.getElementById('searchExt').value.toLowerCase();
        const sort = document.getElementById('sortExt').value;

        extFiltered = extData.filter(d => {
            if(txt && !d.content.toLowerCase().includes(txt) && !d.author.toLowerCase().includes(txt)) return false;
            if(sent !== 'all' && ((sent==='positive' && d.sentiment!=='Positivo') || (sent==='negative' && d.sentiment!=='Negativo') || (sent==='neutral' && d.sentiment!=='Neutro'))) return false;
            if(chan !== 'all' && d.channel !== chan) return false;
            return true;
        });

        if(sort === 'dateDesc') extFiltered.sort((a,b) => b.date - a.date);
        else if(sort === 'likesDesc') extFiltered.sort((a,b) => b.likes - a.likes);
        else if(sort === 'followersDesc') extFiltered.sort((a,b) => b.followers - a.followers);
        else if(sort === 'lengthDesc') extFiltered.sort((a,b) => b.content.length - a.content.length);
        else if(sort === 'lengthAsc') extFiltered.sort((a,b) => a.content.length - b.content.length);

        document.getElementById('totalContentExt').innerText = formatNumberIT(extFiltered.length);
        renderExtCharts();
        renderExtList();
    }

    function renderExtList() {
        const c = document.getElementById('commentsListExt');
        c.innerHTML = '';
        extFiltered.forEach((item, idx) => {
            let b = item.sentiment === 'Positivo' ? 'sentiment-positive' : (item.sentiment === 'Negativo' ? 'sentiment-negative' : 'sentiment-neutral');
            const d = document.createElement('div');
            d.className = 'comment-item';
            d.onclick = () => openExtModal(idx);
            d.innerHTML = `<div>
                <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">
                    <span class="sentiment-badge ${b}">${item.sentiment}</span>
                    <span style="margin-left:8px;"><i class="${item.iconClass}"></i> ${formatItalianDate(item.date)} - <strong>${item.author}</strong></span>
                    <span class="counter-small">${idx + 1} di ${extFiltered.length}</span>
                </div>
                <div style="margin-top:5px;">${item.content.substring(0, 120)}...</div>
            </div>`;
            c.appendChild(d);
        });
    }

    const customLabelsPlugin = {
        id: 'customLabelsPlugin',
        afterDraw: (chart) => {
            if (chart.config.type !== 'bar') return;
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;

            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            chart.data.labels.forEach((label, index) => {
                const x = xAxis.getPixelForTick(index);
                const y = xAxis.bottom;
                const color = getBrandColor(label);
                const iconChar = brandIconsUnicode[label] || '\uf141';
                
                ctx.font = '900 18px "Font Awesome 6 Brands", "Font Awesome 6 Free"';
                ctx.fillStyle = color;
                ctx.fillText(iconChar, x, y + 5);

                let display = label.toLowerCase();
                display = display.charAt(0).toUpperCase() + display.slice(1);
                
                ctx.font = '12px "Avenir Next LT Pro", "Avenir Next", "Helvetica", Arial, sans-serif';
                ctx.fillStyle = '#333333';
                ctx.fillText(display, x, y + 28);
            });
            ctx.restore();
        }
    };

    function renderExtCharts() {
        const ctxS = document.getElementById('sentimentChartExt').getContext('2d');
        const ctxC = document.getElementById('channelChartExt').getContext('2d');
        const ctxE = document.getElementById('engagementChartExt').getContext('2d');

        if(extCharts.sent) extCharts.sent.destroy();
        if(extCharts.chan) extCharts.chan.destroy();
        if(extCharts.eng) extCharts.eng.destroy();

        let sCounts = { Pos: 0, Neu: 0, Neg: 0 };
        extFiltered.forEach(d => {
            if(d.sentiment==='Positivo') sCounts.Pos++;
            else if(d.sentiment==='Negativo') sCounts.Neg++;
            else sCounts.Neu++;
        });

        extCharts.sent = new Chart(ctxS, {
            type: 'doughnut',
            data: { labels: ['Positivo','Neutro','Negativo'], datasets: [{ data: [sCounts.Pos, sCounts.Neu, sCounts.Neg], backgroundColor: ['#28a745', '#ffc107', '#dc3545'], borderWidth:0 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, datalabels:{display:false}}, cutout:'60%' }
        });
        document.getElementById('legendExt').innerHTML = `
            <div class="legend-item"><span class="legend-color" style="background:#28a745"></span>Positivo ${Math.round(sCounts.Pos/extFiltered.length*100)||0}%</div>
            <div class="legend-item"><span class="legend-color" style="background:#ffc107"></span>Neutro ${Math.round(sCounts.Neu/extFiltered.length*100)||0}%</div>
            <div class="legend-item"><span class="legend-color" style="background:#dc3545"></span>Negativo ${Math.round(sCounts.Neg/extFiltered.length*100)||0}%</div>
        `;

        const threshC = parseInt(document.getElementById('threshChan').value) || 0;
        let cCounts = {};
        extFiltered.forEach(d => cCounts[d.channel] = (cCounts[d.channel]||0)+1);
        
        let cAggEntries = [];
        let cOtherSum = 0;
        Object.entries(cCounts).forEach(([chan, val]) => {
            if(val < threshC) cOtherSum += val;
            else cAggEntries.push([chan, val]);
        });
        if(cOtherSum > 0) cAggEntries.push(['Altro', cOtherSum]);
        cAggEntries.sort((a,b) => b[1] - a[1]);
        
        let chanLabels = cAggEntries.map(e => e[0]); 
        let chanData = cAggEntries.map(e => e[1]);
        
        extCharts.chan = new Chart(ctxC, {
            type: 'bar',
            data: { labels: chanLabels, datasets: [{ data: chanData, backgroundColor: '#b0c8f8', borderRadius:4, barPercentage: 0.9, categoryPercentage: 0.95 }] },
            options: { 
                responsive:true, maintainAspectRatio:false, layout: { padding: { bottom: 60 } },
                plugins:{ legend:{display:false}, datalabels:{anchor:'end', align:'end', formatter:(v)=>formatNumberIT(v)}, customLabelsPlugin }, 
                scales:{
                    x:{ grid:{display:false}, ticks: { display: false } }, 
                    y:{display:false, grace: '15%'} 
                } 
            },
            plugins: [ChartDataLabels, customLabelsPlugin]
        });

        const threshE = parseInt(document.getElementById('threshEng').value) || 0;
        let lCounts = {};
        let totalLikes = 0;
        extFiltered.forEach(d => {
            if(d.channel !== 'Web/News') {
                lCounts[d.channel] = (lCounts[d.channel]||0) + d.likes;
                totalLikes += d.likes;
            }
        });
        document.getElementById('totalLikesExt').innerText = formatNumberIT(totalLikes);

        let aggEntries = [];
        let otherSum = 0;
        Object.entries(lCounts).forEach(([chan, val]) => {
            if(val < threshE) otherSum += val;
            else aggEntries.push([chan, val]);
        });
        if(otherSum > 0) aggEntries.push(['Altro', otherSum]);
        
        aggEntries.sort((a,b) => b[1] - a[1]);

        let engLabels = aggEntries.map(e => e[0]); 
        let engData = aggEntries.map(e => e[1]);

        extCharts.eng = new Chart(ctxE, {
            type: 'bar',
            data: { labels: engLabels, datasets: [{ data: engData, backgroundColor: '#b0c8f8', borderRadius:4, barPercentage: 0.9, categoryPercentage: 0.95 }] },
            options: { 
                responsive:true, maintainAspectRatio:false, layout: { padding: { bottom: 60 } },
                plugins:{ legend:{display:false}, datalabels:{anchor:'end', align:'end', formatter:(v)=>formatNumberIT(v)}, customLabelsPlugin }, 
                scales:{
                    x:{ grid:{display:false}, ticks: { display: false } }, 
                    y:{display:false, grace: '15%'} 
                } 
            },
            plugins: [ChartDataLabels, customLabelsPlugin]
        });
    }

    const modalExt = document.getElementById('editorModalExt');
    
    function openExtModal(idx) {
        extIdx = idx;
        const d = extFiltered[extIdx];
        currentCardImage = d.customImage || null; 
        updateExtCard();
        modalExt.style.display = 'flex';
    }

    function removeCardImage() {
        if(!confirm("Rimuovere davvero l'immagine?")) return;
        currentCardImage = null;
        if(isEditing && editTargetItem) {
            editTargetItem.customImage = null;
        }
        updateExtCard();
    }
    
    function manualSaveImage() {
        if(!currentCardImage) return alert("Nessuna immagine da salvare");
        if(isEditing && editTargetItem) {
            if(confirm("Salvare l'immagine corrente su questa scheda?")) {
                editTargetItem.customImage = currentCardImage;
                alert("Immagine salvata nel record!");
            }
        } else {
            alert("Immagine pronta per la nuova scheda.");
        }
    }

    function updateExtCard() {
        if(extIdx < 0 || extIdx >= extFiltered.length) return;
        const d = extFiltered[extIdx];
        document.getElementById('counterExt').innerText = `${extFiltered.length - extIdx}`;
        const r = document.querySelector(`input[name="sentExt"][value="${d.sentiment}"]`);
        if(r) r.checked = true;
        const cont = document.getElementById('previewAreaExt');
        const showAut = document.getElementById('showAuthorExt').checked;
        const showSrc = document.getElementById('showOrigAuthorExt').checked;
        const showLikes = document.getElementById('showLikesExt').checked && d.likes >= 50;
        const showFoll = document.getElementById('showFollowersExt').checked && d.followers >= 50;
        document.getElementById('linkExt').href = d.url;
        let iconHtml = d.channel.includes('Twitter') ? `<svg class="card-icon" viewBox="0 0 24 24"><path d="${icons.twitter}"/></svg>` : `<i class="${d.iconClass} card-icon-fa"></i>`;
        
        document.getElementById('btnRemoveImg').style.display = currentCardImage ? 'inline-block' : 'none';

        const labelFollower = (d.isSocial) ? "Followers" : "Audience";

        cont.innerHTML = `
            <div class="social-card" id="captureCardExt">
                <div class="card-header">
                    <div style="display:flex; align-items:center;">${iconHtml} <span style="font-weight:bold; color:var(--brand-blue);" contenteditable="true">${d.channel}</span></div>
                    <span class="card-date" contenteditable="true">${formatItalianDate(d.date)}</span>
                </div>
                <div class="card-body">
                    ${currentCardImage ? `<img src="${currentCardImage}" class="card-custom-image">` : ''}
                    <div style="font-size:1.1rem; line-height:1.6;" contenteditable="true">${smartTruncate(d.content, 550)}</div>
                </div>
                <div class="card-footer">
                    <div style="display:flex; flex-direction:column;">
                        ${showAut ? `<span style="font-weight:bold; font-size:1.3rem;" contenteditable="true">${d.author}</span>` : ''}
                        ${d.subAuthor && showSrc ? `<span style="font-size:0.85rem; color:#999;" contenteditable="true">${d.subAuthor}</span>` : ''}
                        ${showFoll ? `<span style="font-size:0.8rem; opacity:0.8; margin-top:3px;">${labelFollower}: ${formatNumberIT(d.followers)}</span>` : ''}
                    </div>
                    <div style="display:flex; gap:15px; align-items:center;">
                        ${showLikes ? `<div style="font-weight:bold; color:#e0245e;"><i class="fas fa-heart"></i> ${formatNumberIT(d.likes)}</div>` : ''}
                    </div>
                </div>
            </div>`;
    }

    document.getElementById('closeModalExt').onclick = () => modalExt.style.display = 'none';
    document.getElementById('modalPrevExt').onclick = () => { if(extIdx > 0) openExtModal(extIdx - 1); };
    document.getElementById('modalNextExt').onclick = () => { if(extIdx < extFiltered.length - 1) openExtModal(extIdx + 1); };
    document.querySelectorAll('input[name="sentExt"]').forEach(r => {
        r.addEventListener('change', (e) => {
            const item = extFiltered[extIdx];
            item.sentiment = e.target.value;
            item.sentimentVal = item.sentiment === 'Positivo' ? 1 : (item.sentiment === 'Negativo' ? -1 : 0);
            updateExtCard();
            renderExtCharts();
            renderExtList();
            e.target.blur(); 
        });
    });

    ['showAuthorExt', 'showOrigAuthorExt', 'showLikesExt', 'showFollowersExt'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('change', updateExtCard);
    });

    const imgUpload = document.getElementById('imgUploadExt');
    if(imgUpload) {
        imgUpload.addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const r = new FileReader();
                r.onload = (ev) => { 
                    currentCardImage = ev.target.result;
                    if(isEditing && editTargetItem) editTargetItem.customImage = currentCardImage;
                    updateExtCard(); 
                };
                r.readAsDataURL(e.target.files[0]);
            }
        });
    }

    document.getElementById('dlBtnExt').onclick = () => dlCanvas('captureCardExt');
    document.getElementById('copyBtnExt').onclick = () => copyCanvas('captureCardExt', 'copyBtnExt');

    const manModal = document.getElementById('manualModal');
    function openManualModal() {
        isEditing = false; editTargetItem = null;
        currentCardImage = null; 
        document.getElementById('manContent').value = '';
        document.getElementById('manDate').value = new Date().toISOString().slice(0,16);
        document.getElementById('saveManualBtn').innerText = "Aggiungi al Dataset";
        const r = document.querySelector('input[name="manSent"][value="0"]');
        if(r) r.checked = true;
        manModal.style.display = 'block'; 
        manModal.style.display = 'flex';
    }

    document.getElementById('editExt').onclick = () => {
        if(!extFiltered.length) return;
        isEditing = true; editTargetItem = extFiltered[extIdx];
        document.getElementById('manContent').value = editTargetItem.content;
        const d = editTargetItem.date;
        document.getElementById('manDate').value = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0,16);
        document.getElementById('manChannel').value = editTargetItem.channel;
        document.getElementById('manAuthor').value = editTargetItem.author;
        document.getElementById('manLikes').value = editTargetItem.likes;
        document.getElementById('manFollowers').value = editTargetItem.followers;
        document.getElementById('manUrl').value = editTargetItem.url;
        document.getElementById('saveManualBtn').innerText = "Salva Modifiche";
        let val = '0';
        if(editTargetItem.sentimentVal > 0) val = '1';
        if(editTargetItem.sentimentVal < 0) val = '-1';
        const r = document.querySelector(`input[name="manSent"][value="${val}"]`);
        if(r) r.checked = true;
        modalExt.style.display = 'none';
        manModal.style.display = 'flex';
    };

    document.getElementById('delExt').onclick = () => {
        if(!confirm("Eliminare definitivamente questo record?")) return;
        const itemToDelete = extFiltered[extIdx];
        extData = extData.filter(x => x !== itemToDelete);
        updateExtUI();
        if(extFiltered.length > 0) {
            if(extIdx >= extFiltered.length) extIdx = extFiltered.length - 1;
            openExtModal(extIdx);
        } else {
            modalExt.style.display = 'none';
        }
    };

    function closeManualModal() { 
        manModal.style.display = 'none';
        if(isEditing) modalExt.style.display = 'flex';
    }

    function saveManualPost() {
        const cont = document.getElementById('manContent').value;
        const date = new Date(document.getElementById('manDate').value);
        const chan = document.getElementById('manChannel').value;
        const url = document.getElementById('manUrl').value;
        const aut = document.getElementById('manAuthor').value || "Autore Sconosciuto";
        const likes = parseInt(document.getElementById('manLikes').value)||0;
        const foll = parseInt(document.getElementById('manFollowers').value)||0;
        const sVal = parseInt(document.querySelector('input[name="manSent"]:checked').value);
        const sent = sVal > 0 ? 'Positivo' : (sVal < 0 ? 'Negativo' : 'Neutro');
        if(!url || !chan) return alert("URL e Canale obbligatori");
        
        if(!isEditing) {
            const item = {
                date: date, content: cont, author: aut, channel: chan, likes: likes, followers: foll,
                sentiment: sent, sentimentVal: sVal, url: url, hash: generateHash(cont, date, aut),
                iconClass: chan.toLowerCase().includes('twitter')?'fab fa-twitter':'fas fa-globe', isSocial: true,
                customImage: null 
            };
            handleExtImport([item]);
        } else {
            Object.assign(editTargetItem, {
               date: date, content: cont, author: aut, channel: chan, likes: likes, followers: foll,
               sentiment: sent, sentimentVal: sVal, url: url
            });
            refreshExtDashboard();
            updateExtCard();
        }
        closeManualModal();
    }

    function exportExtJSON() {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(extData));
        a.download = "export.json";
        a.click();
    }
    
    // FUNZIONE DI IMPORTAZIONE INTELLIGENTE
    function importExtJSON(inp) {
        if(inp.files[0]) {
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    let items = [];
                    
                    // Rileva se √® un backup completo o un export semplice
                    if(Array.isArray(json)) {
                        items = json;
                    } else if(json.external && Array.isArray(json.external)) {
                        items = json.external;
                    } else {
                        throw new Error("Formato non riconosciuto");
                    }

                    handleExtImport(items.map(x => ({
                        ...x, 
                        date: new Date(x.date),
                        customImage: x.customImage || null,
                        likes: x.likes || 0,
                        followers: x.followers || 0
                    })));
                } catch(e) { 
                    alert("Errore nel file JSON: Assicurati che sia un export valido.");
                    console.error(e); 
                }
            };
            r.readAsText(inp.files[0]);
        }
    }

    function exportFullState() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const filename = `AnalisiSentiment_${year}_${month}_${day}_${hour}_${minute}.json`;
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({proprietary:propComments, external:extData}));
        a.download = filename;
        a.click();
    }

    function importFullState(inp) {
        if(inp.files[0]) {
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.proprietary) { propComments=d.proprietary.map(x=>({...x,date:new Date(x.date)})); initPropDashboard(); }
                    if(d.external) { 
                        extData = d.external.map(x=>({
                            ...x,
                            date: new Date(x.date),
                            customImage: x.customImage || null,
                            likes: x.likes || 0,
                            followers: x.followers || 0
                        })); 
                        refreshExtDashboard(); 
                    }
                } catch(e){
                    console.error(e);
                    alert("Errore Backup");
                }
            };
            r.readAsText(inp.files[0]);
        }
    }
</script>
</body>
</html>
